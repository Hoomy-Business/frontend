import{j as e,u as te,b as R}from"./query-vendor-yCE0qXS-.js";import{r as x,i as fe,u as ve,L as se}from"./react-vendor-CvpuY9Ms.js";import{M as B}from"./MainLayout-BNeTwvB_.js";import{h as G,B as m,X as ye,g as Ne,a as be,n as we,q as _,c as S,S as Ce,C as q,d as $,e as Y,f as K,b as M,k as _e,l as Se}from"./index-42cH5BrD.js";import{B as ne}from"./badge-7FXoCMHb.js";import{S as A}from"./separator-Dbciv4m9.js";import{A as E,a as P}from"./alert-DAdm-3vK.js";import{C as ae,T as De,a as Le,b as Q,c as V}from"./tabs-DumrchZ7.js";import{D as re,b as ie,c as ce,d as oe,e as le,f as de}from"./dialog-BnpweDKq.js";import{I}from"./input-BQfOhgGT.js";import{L as U}from"./label-67qstHpt.js";import{F as me}from"./file-text-BpuVBWhj.js";import{C as W}from"./clock-DSFRbyAp.js";import{C as z}from"./circle-check-Cikh5ACT.js";import{A as Fe}from"./arrow-left-C-AsHpik.js";import{S as Ee}from"./square-pen-CpZ785qx.js";import{C as O}from"./credit-card-BDXZeHBZ.js";import"./Logo-Bsxlbf95.js";import"./ui-vendor-3oCJfrha.js";import"./user--iiFN26U.js";import"./building-2-DW-G4Bjl.js";const Pe=G("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);const X=G("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]);const ke=G("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);function Te({onSave:L,onCancel:r,title:w,description:p,onRef:N}){const g=x.useRef(null),a=x.useRef(!1),[f,v]=x.useState(!1),D=()=>{const n=g.current;if(!n)return console.error("Canvas ref is null"),null;const i=n.getContext("2d");if(!i)return console.error("Cannot get canvas context"),null;try{if(!i.getImageData(0,0,n.width,n.height).data.some((h,b)=>b%4===3&&h>0))return console.error("Canvas appears to be empty"),null}catch(t){console.error("Error checking canvas content:",t)}const y=n.toDataURL("image/png");return y.length,y.substring(0,30),y};x.useEffect(()=>{N&&N({getSignature:D})},[N]),x.useEffect(()=>{const n=g.current;if(!n)return;const i=n.getContext("2d");if(!i)return;const y=()=>{const l=n.getBoundingClientRect(),o=window.devicePixelRatio||1;(n.width!==l.width*o||n.height!==l.height*o)&&(n.width=l.width*o,n.height=l.height*o,i.scale(o,o)),i.strokeStyle="#000",i.lineWidth=2,i.lineCap="round",i.lineJoin="round"};y();const t=l=>{const o=n.getBoundingClientRect();if(l instanceof MouseEvent)return{x:l.clientX-o.left,y:l.clientY-o.top};{const j=l.touches[0]||l.changedTouches[0];return j?{x:j.clientX-o.left,y:j.clientY-o.top}:{x:0,y:0}}},c=l=>{l.preventDefault(),a.current=!0;const o=t(l);i.beginPath(),i.moveTo(o.x,o.y)},h=l=>{if(!a.current)return;l.preventDefault();const o=t(l);i.lineTo(o.x,o.y),i.stroke(),v(!0)},b=()=>{a.current&&(a.current=!1)};n.addEventListener("mousedown",c),n.addEventListener("mousemove",h),n.addEventListener("mouseup",b),n.addEventListener("mouseleave",b),n.addEventListener("touchstart",c),n.addEventListener("touchmove",h),n.addEventListener("touchend",b);const F=()=>{y()};return window.addEventListener("resize",F),()=>{n.removeEventListener("mousedown",c),n.removeEventListener("mousemove",h),n.removeEventListener("mouseup",b),n.removeEventListener("mouseleave",b),n.removeEventListener("touchstart",c),n.removeEventListener("touchmove",h),n.removeEventListener("touchend",b),window.removeEventListener("resize",F)}},[]);const C=()=>{const n=g.current;if(!n)return;const i=n.getContext("2d");i&&(i.clearRect(0,0,n.width,n.height),v(!1))},u=()=>{const n=g.current;if(!n||!f)return;const i=n.toDataURL("image/png");L(i)};return e.jsxs("div",{className:"space-y-4",children:[w&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:w}),p&&e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:p})]}),e.jsx("div",{className:"border-2 border-dashed border-muted-foreground/25 rounded-lg p-4 bg-muted/20",children:e.jsx("canvas",{ref:g,className:"w-full h-48 cursor-crosshair touch-none bg-white rounded",style:{maxWidth:"100%"}})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(m,{type:"button",variant:"outline",onClick:C,disabled:!f,children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Effacer"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{type:"button",variant:"outline",onClick:r,children:[e.jsx(ye,{className:"h-4 w-4 mr-2"}),"Annuler"]}),e.jsx(m,{type:"button",onClick:u,disabled:!f,children:"Enregistrer la signature"})]})]}),!f&&e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"Veuillez signer dans la zone ci-dessus"})]})}function He({open:L,onOpenChange:r,onSign:w,role:p,contractTitle:N,isLoading:g=!1}){const a=x.useRef(null),[f,v]=x.useState(""),[D,C]=x.useState(!1),u=c=>{v(c)},n=async()=>{let c=null;if(a.current&&(c=a.current.getSignature()),c||(c=f),!c){console.error("No signature to send - canvas and saved data are both empty");return}if(!c.startsWith("data:image/")){console.error("Invalid signature format:",c.substring(0,50));return}if(c.length<100){console.error("Signature seems empty, length:",c.length);return}c.length,c.substring(0,50),C(!0);try{await w(c),v(""),r(!1)}catch(h){console.error("Error signing contract:",h)}finally{C(!1)}},i=()=>{v(""),r(!1)},y=p==="owner"?"Propriétaire":"Locataire",t=p==="owner"?"Lessor":"Lessee";return e.jsx(re,{open:L,onOpenChange:r,children:e.jsxs(ie,{className:"sm:max-w-2xl",children:[e.jsxs(ce,{children:[e.jsxs(oe,{className:"flex items-center gap-2",children:[e.jsx(me,{className:"h-5 w-5"}),"Signature du contrat"]}),e.jsxs(le,{children:[N&&e.jsx("span",{className:"block mb-2 font-medium",children:N}),"En tant que ",e.jsx("strong",{children:y}),", veuillez signer électroniquement le contrat de location."]})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs(E,{children:[e.jsx(Ne,{className:"h-4 w-4"}),e.jsxs(P,{children:[e.jsx("p",{className:"font-medium mb-1",children:"Important"}),e.jsx("p",{className:"text-sm",children:"En signant ce contrat, vous confirmez avoir lu et approuvé toutes les conditions. La signature électronique a la même valeur légale qu'une signature manuscrite selon la loi suisse."})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-sm font-medium",children:["Signature du ",y," (LE ",t.toUpperCase(),")"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"(Signature précédée de la mention « Lu et approuvé »)"})]}),e.jsx(Te,{onSave:u,onCancel:i,onRef:c=>{a.current=c},title:"Votre signature",description:"Veuillez signer dans la zone ci-dessous en utilisant votre souris ou votre doigt"}),f&&e.jsxs("div",{className:"mt-4 p-3 bg-muted rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Aperçu de votre signature :"}),e.jsx("div",{className:"border rounded p-2 bg-white",children:e.jsx("img",{src:f,alt:"Signature preview",className:"max-h-20 mx-auto"})})]})]}),e.jsxs(de,{children:[e.jsx(m,{type:"button",variant:"outline",onClick:i,disabled:D||g,children:"Annuler"}),e.jsx(m,{type:"button",onClick:n,disabled:!f||D||g,children:D||g?"Signature en cours...":"Confirmer et signer"})]})]})})}function st(){const L=fe(),r=L.id?parseInt(L.id):null,{isStudent:w,isOwner:p,isAuthenticated:N}=be(),[,g]=ve(),{toast:a}=we(),[f,v]=x.useState(!1),[D,C]=x.useState(!1),[u,n]=x.useState({monthly_rent:0,charges:0,deposit_amount:0,start_date:"",end_date:""});x.useEffect(()=>{if(!N){g("/login");return}},[N,g]),x.useEffect(()=>{const s=new URLSearchParams(window.location.search),d=s.get("payment"),k=s.get("type");d==="success"?(_.invalidateQueries({queryKey:["/contracts",r]}),_.invalidateQueries({queryKey:["/contracts/payments",r]}),a(k==="deposit"?{title:"Deposit Payment Successful",description:"Your security deposit has been successfully processed."}:{title:"Payment Setup Successful",description:"Your subscription has been set up successfully. Monthly payments will be processed automatically."}),window.history.replaceState({},"",window.location.pathname)):d==="cancelled"&&(a({title:"Payment Cancelled",description:"The payment was cancelled. You can try again anytime.",variant:"destructive"}),window.history.replaceState({},"",window.location.pathname))},[r,a]);const{data:i,isLoading:y}=te({queryKey:["/contracts",r],enabled:!!r&&N,queryFn:async()=>{if(!r)throw new Error("Contract ID required");return S("GET",`/contracts/${r}`)}}),t=i==null?void 0:i.contract;x.useEffect(()=>{if(t&&t.start_date&&t.end_date){const s=t.start_date.split("T")[0]||"",d=t.end_date.split("T")[0]||"";n({monthly_rent:t.monthly_rent,charges:t.charges??0,deposit_amount:t.deposit_amount,start_date:s,end_date:d})}},[t]);const c=R({mutationFn:s=>S("PUT",`/contracts/${r}`,s),onSuccess:()=>{_.invalidateQueries({queryKey:["/contracts",r]}),_.invalidateQueries({queryKey:["/contracts/my-contracts"]}),a({title:"Succès",description:"Contrat mis à jour avec succès"}),v(!1)},onError:s=>{a({title:"Erreur",description:s.message,variant:"destructive"})}}),h=R({mutationFn:s=>{if(s==null||s.length,s==null||s.substring(0,50),!s||!s.startsWith("data:image/"))throw console.error("Invalid signature format before sending:",s==null?void 0:s.substring(0,100)),new Error("Format de signature invalide");return w?S("PUT",`/contracts/${r}/accept`,{signature:s}):S("PUT",`/contracts/${r}/status`,{status:"active",signature:s})},onSuccess:()=>{_.invalidateQueries({queryKey:["/contracts",r]}),_.invalidateQueries({queryKey:["/contracts/my-contracts"]}),a({title:"Succès",description:"Contrat signé avec succès"}),C(!1)},onError:s=>{a({title:"Erreur",description:s.message,variant:"destructive"})}}),b=async s=>{await h.mutateAsync(s)},F=R({mutationFn:()=>S("POST","/contracts/create-subscription",{contract_id:r}),onSuccess:s=>{if(s.requires_owner_setup){a({title:"Owner Setup Required",description:"The property owner must complete their Stripe setup before payments can be processed.",variant:"destructive"});return}s.checkout_url?(a({title:"Redirecting to Stripe",description:"You will be redirected to complete your payment setup."}),window.location.href=s.checkout_url):a({title:"Error",description:"No checkout URL received from server.",variant:"destructive"})},onError:s=>{const d=s.message||"Failed to create subscription. Please try again.";a({title:"Payment Setup Error",description:d,variant:"destructive"})}}),l=R({mutationFn:()=>S("POST","/contracts/cancel-subscription",{contract_id:r}),onSuccess:()=>{_.invalidateQueries({queryKey:["/contracts",r]}),_.invalidateQueries({queryKey:["/contracts/payments",r]}),a({title:"Subscription Cancelled",description:"Your subscription has been cancelled. Automatic payments will stop."})},onError:s=>{a({title:"Cancellation Error",description:s.message||"Failed to cancel subscription. Please try again.",variant:"destructive"})}}),o=R({mutationFn:()=>S("POST","/contracts/pay-deposit",{contract_id:r}),onSuccess:s=>{if(s.requires_owner_setup){a({title:"Owner Setup Required",description:"The property owner must complete their Stripe setup before payments can be processed.",variant:"destructive"});return}s.checkout_url?(a({title:"Redirecting to Stripe",description:"You will be redirected to complete your deposit payment."}),window.location.href=s.checkout_url):a({title:"Error",description:"No checkout URL received from server.",variant:"destructive"})},onError:s=>{const d=s.message||"Failed to process deposit payment. Please try again.";a({title:"Payment Error",description:d,variant:"destructive"})}}),{data:j}=te({queryKey:["/contracts/payments",r],enabled:!!r&&(t==null?void 0:t.status)==="active",queryFn:async()=>{if(!r)throw new Error("Contract ID required");return S("GET",`/contracts/payments/${r}`)}}),ue=async()=>{if(!r){a({title:"Erreur",description:"ID de contrat manquant",variant:"destructive"});return}const s=_e();if(!s){a({title:"Erreur",description:"Vous devez être connecté pour télécharger le PDF",variant:"destructive"});return}try{const pe=`${Se().replace(/\/+$/,"")}/contracts/${r}/pdf`,T=await fetch(pe,{method:"GET",headers:{Authorization:`Bearer ${s}`}});if(!T.ok){const je=await T.json().catch(()=>({error:"Erreur lors du téléchargement"}));throw new Error(je.error||`Erreur ${T.status}: ${T.statusText}`)}const ge=await T.blob(),ee=window.URL.createObjectURL(ge),H=document.createElement("a");H.href=ee,H.download=`contract-${r}.pdf`,document.body.appendChild(H),H.click(),document.body.removeChild(H),window.URL.revokeObjectURL(ee),a({title:"Succès",description:"PDF téléchargé avec succès"})}catch(d){console.error("Erreur téléchargement PDF:",d),a({title:"Erreur",description:d instanceof Error?d.message:"Impossible de télécharger le PDF",variant:"destructive"})}};if(y)return e.jsx(B,{children:e.jsx("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsx(Ce,{className:"h-96 w-full max-w-4xl mx-auto"})})});if(!t)return e.jsx(B,{children:e.jsxs("div",{className:"container mx-auto px-4 py-16 text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Contract Not Found"}),e.jsx(se,{href:p?"/dashboard/owner":"/dashboard/student",children:e.jsx(m,{"data-testid":"button-dashboard",children:"Back to Dashboard"})})]})});const J=w&&t.status==="pending"&&!t.student_signature||p&&t.status==="pending"&&!t.owner_signature,he=p&&t.status==="pending"&&!t.owner_signature,xe=w&&t.status==="pending"&&!t.student_signature,Z={pending:e.jsx(W,{className:"h-5 w-5 text-yellow-600"}),active:e.jsx(z,{className:"h-5 w-5 text-green-600"}),completed:e.jsx(z,{className:"h-5 w-5 text-green-600"}),cancelled:e.jsx(ae,{className:"h-5 w-5 text-red-600"})}[t.status];return e.jsxs(B,{children:[e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx(se,{href:p?"/dashboard/owner":"/dashboard/student",children:e.jsxs(m,{variant:"ghost",className:"mb-4","data-testid":"button-back",children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Back to Dashboard"]})}),e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs(q,{children:[e.jsx($,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(me,{className:"h-6 w-6 text-muted-foreground"}),e.jsx(Y,{children:"Rental Contract"})]}),e.jsxs(K,{children:["Contract ID: ",t.id]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Z,e.jsx(ne,{variant:t.status==="active"?"default":t.status==="pending"?"secondary":"outline",children:t.status})]})]})}),e.jsxs(M,{className:"space-y-6",children:[J&&e.jsx(E,{children:e.jsxs(P,{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsxs("span",{children:[xe&&"Veuillez examiner et signer ce contrat pour procéder avec votre location",he&&"Veuillez signer ce contrat pour le finaliser"]}),e.jsx(m,{onClick:()=>C(!0),disabled:h.isPending,"data-testid":"button-sign-contract",children:h.isPending?"Signature en cours...":"Signer le contrat"})]})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Property Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Property"}),e.jsx("p",{className:"font-medium","data-testid":"text-property-title",children:t.property_title})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Location"}),e.jsx("p",{className:"font-medium",children:t.city_name})]})]})]}),e.jsx(A,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Parties"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Property Owner"}),e.jsxs("p",{className:"font-medium",children:[t.owner_first_name," ",t.owner_last_name]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Tenant"}),e.jsxs("p",{className:"font-medium",children:[t.student_first_name," ",t.student_last_name]})]})]})]}),e.jsx(A,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Contract Terms"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Start Date"}),e.jsx("p",{className:"font-medium",children:new Date(t.start_date).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"End Date"}),e.jsx("p",{className:"font-medium",children:new Date(t.end_date).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Duration"}),e.jsxs("p",{className:"font-medium",children:[Math.round((new Date(t.end_date).getTime()-new Date(t.start_date).getTime())/(1e3*60*60*24*30))," months"]})]})]})]}),e.jsx(A,{}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold",children:"Financial Details"}),p&&(t.status==="pending"||t.is_editable)&&e.jsxs(m,{variant:"outline",size:"sm",onClick:()=>{if(t&&t.start_date&&t.end_date){const s=t.start_date.split("T")[0]||"",d=t.end_date.split("T")[0]||"";n({monthly_rent:t.monthly_rent,charges:t.charges??0,deposit_amount:t.deposit_amount,start_date:s,end_date:d}),v(!0)}},children:[e.jsx(Ee,{className:"h-4 w-4 mr-2"}),"Modifier"]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Monthly Rent"}),e.jsxs("p",{className:"font-semibold text-lg",children:["CHF ",Number(t.monthly_rent||0).toLocaleString("fr-CH",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Charges"}),e.jsxs("p",{className:"font-semibold text-lg",children:["CHF ",Number(t.charges||0).toLocaleString("fr-CH",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Deposit"}),e.jsxs("p",{className:"font-semibold text-lg",children:["CHF ",Number(t.deposit_amount||0).toLocaleString("fr-CH",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),p&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Your Monthly Payout"}),e.jsxs("p",{className:"font-semibold text-lg",children:["CHF ",Number(t.owner_payout||0).toLocaleString("fr-CH",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"After platform fee"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total mensuel"}),e.jsxs("p",{className:"font-semibold text-lg",children:["CHF ",(Number(t.monthly_rent||0)+Number(t.charges||0)).toLocaleString("fr-CH",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Loyer + Charges"})]})]})]}),e.jsx(A,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Signatures"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Propriétaire (LE BAILLEUR)"}),t.owner_signature?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"border rounded p-3 bg-muted/20",children:e.jsx("img",{src:t.owner_signature,alt:"Signature du propriétaire",className:"max-h-20 mx-auto"})}),t.owner_signed_at&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Signé le ",new Date(t.owner_signed_at).toLocaleDateString("fr-CH",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})]})]}):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"En attente de signature"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Locataire (LE LOCATAIRE)"}),t.student_signature?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"border rounded p-3 bg-muted/20",children:e.jsx("img",{src:t.student_signature,alt:"Signature du locataire",className:"max-h-20 mx-auto"})}),t.student_signed_at&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Signé le ",new Date(t.student_signed_at).toLocaleDateString("fr-CH",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})]})]}):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"En attente de signature"})]})]})]}),e.jsx(A,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Contract Status"}),e.jsxs("div",{className:"flex items-center gap-2",children:[Z,e.jsxs("p",{className:"text-sm",children:[t.status==="active"&&"Contract is active",t.status==="pending"&&"Contract is pending approval",t.status==="completed"&&"Contract has been completed",t.status==="cancelled"&&"Contract has been cancelled"]})]})]}),e.jsxs(De,{defaultValue:"details",className:"w-full",children:[e.jsxs(Le,{className:"grid w-full grid-cols-3",children:[e.jsx(Q,{value:"details",children:"Details"}),(t==null?void 0:t.status)==="active"&&e.jsxs(e.Fragment,{children:[e.jsxs(Q,{value:"payments",children:[e.jsx(O,{className:"h-4 w-4 mr-2"}),"Payments"]}),e.jsxs(Q,{value:"history",children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"History"]})]})]}),e.jsx(V,{value:"details",className:"space-y-4",children:e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsxs(m,{onClick:ue,variant:"outline",className:"flex-1","data-testid":"button-download-pdf",children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Download PDF"]}),J&&e.jsx(m,{onClick:()=>C(!0),disabled:h.isPending,className:"flex-1","data-testid":"button-sign",children:h.isPending?"Signature en cours...":"Signer le contrat"})]})}),(t==null?void 0:t.status)==="active"&&e.jsxs(e.Fragment,{children:[e.jsx(V,{value:"payments",className:"space-y-4",children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx(O,{className:"h-5 w-5"}),"Payment Management"]}),e.jsxs(q,{className:"mb-4",children:[e.jsxs($,{children:[e.jsx(Y,{className:"text-lg",children:"Monthly Subscription"}),e.jsx(K,{children:t.stripe_subscription_id?"Automatic monthly payments are active":"Set up automatic monthly rent payments"})]}),e.jsx(M,{className:"space-y-4",children:t.stripe_subscription_id?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(E,{className:"border-green-200 bg-green-50",children:[e.jsx(z,{className:"h-4 w-4 text-green-600"}),e.jsx(P,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-green-900 mb-1",children:"Subscription Active"}),e.jsx("p",{className:"text-sm text-green-700",children:"Payments are processed automatically on the 1st of each month."})]}),e.jsx(m,{variant:"destructive",size:"sm",onClick:()=>{confirm("Are you sure you want to cancel the subscription? This will stop automatic payments.")&&l.mutate()},disabled:l.isPending,children:l.isPending?"Cancelling...":"Cancel"})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Next Payment"}),e.jsx("p",{className:"font-semibold",children:new Date(new Date().setMonth(new Date().getMonth()+1)).toLocaleDateString("fr-CH",{day:"numeric",month:"long",year:"numeric"})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Amount"}),e.jsxs("p",{className:"font-semibold",children:["CHF ",Number(t.monthly_rent||0).toLocaleString("fr-CH",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})]}):e.jsx("div",{className:"space-y-3",children:e.jsx(E,{children:e.jsx(P,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium mb-1",children:"Set up automatic payments"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Your monthly rent of CHF ",Number(t.monthly_rent||0).toLocaleString("fr-CH",{minimumFractionDigits:2,maximumFractionDigits:2})," will be charged automatically each month."]})]}),e.jsx(m,{onClick:()=>F.mutate(),disabled:F.isPending,className:"ml-4",children:F.isPending?e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"h-4 w-4 mr-2 animate-spin"}),"Setting up..."]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"h-4 w-4 mr-2"}),"Set Up Payments"]})})]})})})})})]}),t.deposit_amount>0&&e.jsxs(q,{children:[e.jsxs($,{children:[e.jsx(Y,{className:"text-lg",children:"Security Deposit"}),e.jsxs(K,{children:["One-time payment of CHF ",Number(t.deposit_amount||0).toLocaleString("fr-CH",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsx(M,{className:"space-y-4",children:(()=>{var d;return((d=j==null?void 0:j.payments)==null?void 0:d.some(k=>k.payment_type==="deposit"&&k.payment_status==="succeeded"))?e.jsxs(E,{className:"border-green-200 bg-green-50",children:[e.jsx(z,{className:"h-4 w-4 text-green-600"}),e.jsxs(P,{children:[e.jsx("p",{className:"font-medium text-green-900 mb-1",children:"Deposit Paid"}),e.jsx("p",{className:"text-sm text-green-700",children:"Your security deposit has been successfully paid. It will be returned at the end of the contract, minus any damages or unpaid fees."})]})]}):e.jsx(E,{children:e.jsx(P,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium mb-1",children:"Pay Security Deposit"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["The security deposit of CHF ",Number(t.deposit_amount||0).toLocaleString("fr-CH",{minimumFractionDigits:2,maximumFractionDigits:2})," will be returned at the end of the contract, minus any damages or unpaid fees."]})]}),w&&e.jsx(m,{onClick:()=>o.mutate(),disabled:o.isPending,className:"w-full sm:w-auto",children:o.isPending?e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"h-4 w-4 mr-2 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"h-4 w-4 mr-2"}),"Pay Deposit"]})})]})})})})()})]})]})})}),e.jsx(V,{value:"history",className:"space-y-4",children:e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5"}),"Payment History"]}),!(j!=null&&j.payments)||j.payments.length===0?e.jsx(q,{children:e.jsxs(M,{className:"p-8 text-center",children:[e.jsx(X,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"No payment history available yet"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Payments will appear here once they are processed."})]})}):e.jsx("div",{className:"space-y-3",children:j.payments.map(s=>e.jsx(q,{children:e.jsx(M,{className:"p-4",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsxs("p",{className:"font-semibold text-lg",children:["CHF ",Number(s.amount||0).toLocaleString("fr-CH",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx(ne,{variant:s.payment_status==="succeeded"?"default":s.payment_status==="pending"?"secondary":"destructive",children:s.payment_status==="succeeded"?"Paid":s.payment_status==="pending"?"Pending":s.payment_status==="failed"?"Failed":s.payment_status})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:s.payment_type==="monthly_rent"?"Monthly Rent":s.payment_type==="deposit"?"Security Deposit":s.payment_type}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(s.created_at).toLocaleDateString("fr-CH",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}),s.paid_at&&e.jsxs("p",{className:"text-xs text-green-600",children:["Paid on ",new Date(s.paid_at).toLocaleDateString("fr-CH")]}),s.failure_reason&&e.jsx("p",{className:"text-xs text-red-600",children:s.failure_reason})]})]}),s.payment_status==="succeeded"&&e.jsx(z,{className:"h-5 w-5 text-green-600 flex-shrink-0"}),s.payment_status==="failed"&&e.jsx(ae,{className:"h-5 w-5 text-red-600 flex-shrink-0"})]})})},s.id))})]})})]})]})]})]})})]}),e.jsx(re,{open:f,onOpenChange:v,children:e.jsxs(ie,{className:"sm:max-w-md",children:[e.jsxs(ce,{children:[e.jsx(oe,{children:"Modifier le contrat"}),e.jsx(le,{children:"Vous pouvez modifier les détails du contrat. Les deux parties doivent être d'accord avec les modifications."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsx(U,{htmlFor:"monthly_rent",children:"Loyer mensuel (CHF)"}),e.jsx(I,{id:"monthly_rent",type:"number",value:u.monthly_rent,onChange:s=>n({...u,monthly_rent:parseFloat(s.target.value)||0})})]}),e.jsxs("div",{children:[e.jsx(U,{htmlFor:"charges",children:"Charges mensuelles (CHF)"}),e.jsx(I,{id:"charges",type:"number",value:u.charges,onChange:s=>n({...u,charges:parseFloat(s.target.value)||0})})]}),e.jsxs("div",{children:[e.jsx(U,{htmlFor:"deposit_amount",children:"Caution (CHF)"}),e.jsx(I,{id:"deposit_amount",type:"number",value:u.deposit_amount,onChange:s=>n({...u,deposit_amount:parseFloat(s.target.value)||0})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(U,{htmlFor:"start_date",children:"Date de début"}),e.jsx(I,{id:"start_date",type:"date",value:u.start_date,onChange:s=>n({...u,start_date:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(U,{htmlFor:"end_date",children:"Date de fin"}),e.jsx(I,{id:"end_date",type:"date",value:u.end_date,onChange:s=>n({...u,end_date:s.target.value})})]})]})]}),e.jsxs(de,{children:[e.jsx(m,{variant:"outline",onClick:()=>v(!1),children:"Annuler"}),e.jsx(m,{onClick:()=>c.mutate(u),disabled:c.isPending,children:c.isPending?"Enregistrement...":"Enregistrer les modifications"})]})]})}),e.jsx(He,{open:D,onOpenChange:C,onSign:b,role:p?"owner":"student",contractTitle:t==null?void 0:t.property_title,isLoading:h.isPending})]})}export{st as default};
