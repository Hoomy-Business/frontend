import{u as H,b as V,j as e}from"./query-vendor-CNIykozp.js";import{r as h,u as Ae,L as J}from"./react-vendor-DdYNpgPf.js";import{n as te,M as Re,e as xe,f as Ue,A as Me,b as Ke,d as Ve}from"./MainLayout-NmdhbHwr.js";import{P as ze}from"./slider-ClMrkBSe.js";import{B as l}from"./button-DFlaW1fX.js";import{C as _,b as O,c as B,d as $,a as q}from"./card-soCmDmm_.js";import{T as Ie,a as Oe,b as Z,c as ee}from"./tabs-JZlzNMbI.js";import{B as C}from"./badge-lbYZ3FY3.js";import{d as Se,h as ke,X as Fe,g as Be,b as y,f as $e,a as Qe,u as qe,S as ae,l as Ye,q as T}from"./index-DQr_hYrl.js";import{S as je}from"./separator-B2wa_seS.js";import{A as G,a as W}from"./alert-C_e47U5j.js";import{I as z}from"./input-BXFQAMFp.js";import{L as I}from"./label-CoUyTYQ2.js";import{D as fe,a as ge,b as ve,c as be,d as Ne,e as we,f as ye}from"./dialog-uVQYQ4ha.js";import{C as ie}from"./circle-alert-Dps9J1jL.js";import{C as _e}from"./circle-check-BT2_QnOW.js";import{L as re,T as He}from"./trash-2-CK1JOWai.js";import{C as Ce}from"./circle-x-DMXThIZO.js";import{U as ce}from"./upload-CSQn2-N8.js";import{C as me,I as Ee,a as Ge}from"./ImageCropDialog-B4zIgawq.js";import{C as We}from"./credit-card-Cy22DRsd.js";import{B as oe}from"./building-2-BFsPi-4G.js";import{F as Pe}from"./file-text-BLH-e9-V.js";import{U as Xe,a as Je}from"./user-CZwPb1SC.js";import{L as Ze}from"./lock-CHXxWoOb.js";import"./Logo-DJHknSUJ.js";import"./ui-vendor-BME24-VV.js";import"./heart-CPIM2Ke7.js";import"./map-pin-B2egFyT_.js";import"./maximize-BflEInwa.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=Se("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const es=Se("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]);function ss(){const{toast:a}=ke(),[g,S]=h.useState(null),[E,u]=h.useState(null),[o,t]=h.useState(null),[P,k]=h.useState(!1),[b,j]=h.useState(!1),[d,p]=h.useState(null),N=h.useRef(null),R=h.useRef(null),c=h.useRef(null),{data:i,isLoading:se,refetch:ne,error:U}=H({queryKey:["/kyc/status"],queryFn:async()=>y("GET","/kyc/status"),retry:1}),F=V({mutationFn:async n=>{const r=Be();if(!r)throw new Error("Non authentifié");const K=`${$e().replace(/\/+$/,"")}/kyc/submit`,Y=await fetch(K,{method:"POST",headers:{Authorization:`Bearer ${r}`},body:n});if(!Y.ok){const le=await Y.json();throw new Error(le.error||"Erreur lors de la soumission du KYC")}return Y.json()},onSuccess:()=>{a({title:"KYC soumis avec succès",description:"Votre demande de vérification a été envoyée. Vous serez notifié une fois la vérification terminée."}),ne(),S(null),u(null),t(null)},onError:n=>{a({title:"Erreur",description:n.message,variant:"destructive"})}});h.useEffect(()=>{if(!P){c.current&&(c.current.getTracks().forEach(r=>r.stop()),c.current=null),j(!1),p(null);return}if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){const r="Votre navigateur ne supporte pas l'accès à la caméra, ou le site doit être en HTTPS.";p(r),j(!1),a({title:"Caméra non disponible",description:r,variant:"destructive"});return}j(!0),p(null);const n=()=>{if(!N.current){setTimeout(n,100);return}navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(r=>{try{c.current=r,N.current?(N.current.srcObject=r,N.current.onloadedmetadata=()=>{j(!1),N.current&&N.current.play().catch(m=>{p("Erreur lors de la lecture de la vidéo"),j(!1)})}):(r.getTracks().forEach(m=>m.stop()),p("Élément vidéo non disponible"),j(!1))}catch{r.getTracks().forEach(L=>L.stop()),p("Erreur lors de la configuration de la caméra"),j(!1)}}).catch(r=>{let m="Impossible d'accéder à la caméra.";r.name==="NotAllowedError"||r.name==="PermissionDeniedError"?m="Permission d'accès à la caméra refusée. Veuillez autoriser l'accès dans les paramètres de votre navigateur.":r.name==="NotFoundError"||r.name==="DevicesNotFoundError"?m="Aucune caméra trouvée sur cet appareil.":r.name==="NotReadableError"||r.name==="TrackStartError"?m="La caméra est déjà utilisée par une autre application.":r.name==="OverconstrainedError"||r.name==="ConstraintNotSatisfiedError"?m="Les paramètres de la caméra ne sont pas supportés.":r.name==="SecurityError"&&(m="Accès à la caméra bloqué pour des raisons de sécurité. Le site doit être en HTTPS."),p(m),j(!1),a({title:"Erreur caméra",description:m,variant:"destructive"})})};return n(),()=>{c.current&&(c.current.getTracks().forEach(r=>r.stop()),c.current=null),j(!1),p(null)}},[P,a]);const de=()=>{if(N.current&&R.current){const n=N.current,r=R.current;r.width=n.videoWidth,r.height=n.videoHeight;const m=r.getContext("2d");m&&(m.drawImage(n,0,0),r.toBlob(L=>{if(L){const K=new File([L],"selfie.jpg",{type:"image/jpeg"});t(K),k(!1)}},"image/jpeg",.9))}},Q=(n,r)=>{n==="front"?S(r):u(r)},f=async()=>{if(!g||!E||!o){a({title:"Documents manquants",description:"Veuillez fournir tous les documents requis.",variant:"destructive"});return}const n=new FormData;n.append("id_card_front",g),n.append("id_card_back",E),n.append("selfie",o),F.mutate(n)},M=()=>{if(!i)return null;switch(i.status){case"approved":return e.jsxs(C,{className:"bg-green-500",children:[e.jsx(_e,{className:"h-3 w-3 mr-1"}),"Vérifié"]});case"pending":return e.jsxs(C,{variant:"secondary",children:[e.jsx(re,{className:"h-3 w-3 mr-1 animate-spin"}),"En attente"]});case"rejected":return e.jsxs(C,{variant:"destructive",children:[e.jsx(Ce,{className:"h-3 w-3 mr-1"}),"Rejeté"]});default:return e.jsxs(C,{variant:"outline",children:[e.jsx(ie,{className:"h-3 w-3 mr-1"}),"Non soumis"]})}};if(se)return e.jsx(_,{children:e.jsxs(O,{children:[e.jsx(B,{children:"Vérification KYC"}),e.jsx($,{children:"Chargement..."})]})});if(U)return e.jsxs(_,{children:[e.jsxs(O,{children:[e.jsx(B,{children:"Vérification KYC"}),e.jsx($,{children:"Erreur de chargement"})]}),e.jsx(q,{children:e.jsxs(G,{variant:"destructive",children:[e.jsx(ie,{className:"h-4 w-4"}),e.jsxs(W,{children:["Impossible de charger le statut KYC. Veuillez vérifier que le serveur backend est démarré et que la route /api/kyc/status est accessible.",e.jsx("br",{}),e.jsxs("small",{className:"text-xs mt-2 block",children:["Erreur: ",U instanceof Error?U.message:"Erreur inconnue"]})]})]})})]});const D=(i==null?void 0:i.is_verified)||(i==null?void 0:i.kyc_verified),w=(i==null?void 0:i.status)==="pending",X=(i==null?void 0:i.status)==="rejected";return e.jsxs(_,{children:[e.jsx(O,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(B,{children:"Vérification KYC"}),e.jsx($,{children:"Vérification d'identité requise pour publier des annonces"})]}),M()]})}),e.jsxs(q,{className:"space-y-6",children:[D&&e.jsxs(G,{children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx(W,{children:"Votre identité a été vérifiée avec succès. Vous pouvez maintenant publier des annonces."})]}),w&&e.jsxs(G,{children:[e.jsx(re,{className:"h-4 w-4 animate-spin"}),e.jsx(W,{children:"Votre demande de vérification est en cours d'examen. Vous serez notifié une fois la vérification terminée."})]}),X&&i.rejection_reason&&e.jsxs(G,{variant:"destructive",children:[e.jsx(Ce,{className:"h-4 w-4"}),e.jsxs(W,{children:[e.jsx("strong",{children:"Vérification rejetée:"})," ",i.rejection_reason,e.jsx("br",{}),"Veuillez soumettre à nouveau vos documents."]})]}),!D&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-medium mb-2 block",children:["Carte d'identité - Recto ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:n=>{var r;return Q("front",((r=n.target.files)==null?void 0:r[0])||null)},className:"hidden",id:"id-card-front",disabled:w}),e.jsx("label",{htmlFor:"id-card-front",children:e.jsx(l,{variant:"outline",asChild:!0,disabled:w,children:e.jsxs("span",{children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),g?"Changer":"Télécharger"]})})}),g&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:URL.createObjectURL(g),alt:"Prévisualisation recto",className:"h-20 w-auto rounded border object-cover"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:g.name})]}),(i==null?void 0:i.id_card_front_url)&&!g&&e.jsx("img",{src:te(i.id_card_front_url),alt:"Carte d'identité recto",className:"h-20 w-auto rounded border",onError:n=>{const r=n.currentTarget;r.src.startsWith("http://")&&(r.src=r.src.replace("http://","https://"))}})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-medium mb-2 block",children:["Carte d'identité - Verso ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:n=>{var r;return Q("back",((r=n.target.files)==null?void 0:r[0])||null)},className:"hidden",id:"id-card-back",disabled:w}),e.jsx("label",{htmlFor:"id-card-back",children:e.jsx(l,{variant:"outline",asChild:!0,disabled:w,children:e.jsxs("span",{children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),E?"Changer":"Télécharger"]})})}),E&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:URL.createObjectURL(E),alt:"Prévisualisation verso",className:"h-20 w-auto rounded border object-cover"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:E.name})]}),(i==null?void 0:i.id_card_back_url)&&!E&&e.jsx("img",{src:te(i.id_card_back_url),alt:"Carte d'identité verso",className:"h-20 w-auto rounded border",onError:n=>{const r=n.currentTarget;r.src.startsWith("http://")&&(r.src=r.src.replace("http://","https://"))}})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-medium mb-2 block",children:["Selfie ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"space-y-4",children:[!P&&!o&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[typeof navigator<"u"&&"mediaDevices"in navigator&&"getUserMedia"in navigator.mediaDevices&&e.jsxs(l,{variant:"outline",onClick:()=>k(!0),disabled:w,children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),"Prendre un selfie"]}),e.jsx("input",{type:"file",accept:"image/*",capture:"user",onChange:n=>{var m;const r=(m=n.target.files)==null?void 0:m[0];r&&t(r)},className:"hidden",id:"selfie-upload",disabled:w}),e.jsx("label",{htmlFor:"selfie-upload",children:e.jsx(l,{variant:"outline",asChild:!0,disabled:w,children:e.jsxs("span",{children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),typeof navigator<"u"&&"mediaDevices"in navigator&&"getUserMedia"in navigator.mediaDevices?"Ou uploader depuis la galerie":"Uploader une photo"]})})})]}),(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"⚠️ La caméra en direct nécessite HTTPS. Vous pouvez uploader une photo depuis votre galerie."})]}),P&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative border rounded-lg overflow-hidden bg-black min-h-[300px] flex items-center justify-center",children:[b&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/50 z-10",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx(re,{className:"h-8 w-8 animate-spin mx-auto mb-2"}),e.jsx("p",{className:"text-sm",children:"Chargement de la caméra..."})]})}),d&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/50 z-10 p-4",children:e.jsxs(G,{variant:"destructive",className:"max-w-md",children:[e.jsx(ie,{className:"h-4 w-4"}),e.jsx(W,{children:d})]})}),e.jsx("video",{ref:N,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full max-w-md mx-auto",style:{transform:"scaleX(-1)",display:d?"none":"block"}}),e.jsx("canvas",{ref:R,className:"hidden"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(l,{onClick:de,disabled:b||!!d||!c.current,children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),"Capturer"]}),e.jsx(l,{variant:"outline",onClick:()=>{k(!1),p(null),j(!1)},children:"Annuler"})]})]}),o&&!P&&e.jsxs("div",{className:"mt-4 flex items-center gap-4",children:[e.jsx("img",{src:URL.createObjectURL(o),alt:"Prévisualisation selfie",className:"h-32 w-auto rounded border object-cover"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium",children:o.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[(o.size/1024).toFixed(1)," KB"]}),e.jsxs(l,{type:"button",variant:"outline",size:"sm",className:"mt-2",onClick:()=>t(null),disabled:w,children:[e.jsx(Fe,{className:"h-3 w-3 mr-1"}),"Supprimer"]})]})]}),(i==null?void 0:i.selfie_url)&&!o&&!P&&e.jsx("div",{className:"mt-4",children:e.jsx("img",{src:te(i.selfie_url),alt:"Selfie soumis",className:"h-32 w-auto rounded border",onError:n=>{const r=n.currentTarget;r.src.startsWith("http://")&&!r.dataset.httpsTried&&(r.dataset.httpsTried="true",r.src=r.src.replace("http://","https://"))}})})]})]})]}),e.jsx(l,{onClick:f,disabled:!g||!E||!o||F.isPending||w,className:"w-full",children:F.isPending?e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"h-4 w-4 mr-2 animate-spin"}),"Soumission en cours..."]}):"Soumettre la vérification"})]})]})]})}function Ds(){var he,pe;const{user:a,isAuthenticated:g,isOwner:S,refreshUser:E}=Qe(),[,u]=Ae();h.useEffect(()=>{if(!g){u("/login");return}S||((a==null?void 0:a.role)==="admin"?u("/admin/dashboard"):u("/dashboard/student"))},[g,S,a==null?void 0:a.role,u]);const{toast:o}=ke(),{t}=qe(),[P,k]=h.useState("properties"),{data:b,isLoading:j,error:d}=H({queryKey:["/properties/my-properties"],queryFn:async()=>{try{const s=await y("GET","/properties/my-properties");return Array.isArray(s)?{properties:s}:s}catch(s){throw console.error("Error fetching properties:",s),s}},staleTime:1e3*60*2,gcTime:1e3*60*10,retry:1}),p=(b==null?void 0:b.properties)||[],{data:N,isLoading:R}=H({queryKey:["/requests/received"],queryFn:async()=>{const s=await y("GET","/requests/received");return Array.isArray(s)?s:[]},staleTime:1e3*30,gcTime:1e3*60*5}),c=Array.isArray(N)?N:[],i=V({mutationFn:({id:s,status:x})=>y("PUT",`/requests/${s}`,{status:x}),onMutate:async({id:s,status:x})=>{await T.cancelQueries({queryKey:["/requests/received"]});const v=T.getQueryData(["/requests/received"]);return v&&Array.isArray(v)&&T.setQueryData(["/requests/received"],v.map(A=>A.id===s?{...A,status:x}:A)),{previousRequests:v}},onSuccess:(s,x)=>{x.status==="accepted"?(T.invalidateQueries({queryKey:["/conversations"]}),o({title:"Requête acceptée",description:"Une conversation a été créée automatiquement avec l'étudiant."})):o({title:"Success",description:"Request updated successfully"})},onError:(s,x,v)=>{v!=null&&v.previousRequests&&T.setQueryData(["/requests/received"],v.previousRequests),o({title:"Error",description:s.message,variant:"destructive"})},onSettled:()=>{T.invalidateQueries({queryKey:["/requests/received"]})}}),{data:se,isLoading:ne}=H({queryKey:["/contracts/my-contracts"],queryFn:async()=>y("GET","/contracts/my-contracts"),select:s=>{const x=s==null?void 0:s.contracts;return Array.isArray(x)?x:[]},staleTime:1e3*60*5,gcTime:1e3*60*15}),U=Array.isArray(se)?se:[],{data:F,isLoading:de}=H({queryKey:["/conversations"],queryFn:async()=>{const s=await y("GET","/conversations");return Array.isArray(s),s},staleTime:1e3*30,gcTime:1e3*60*5}),Q=Array.isArray(F)?F:(F==null?void 0:F.conversations)||[],{data:f}=H({queryKey:["/contracts/connect/account-status"],queryFn:async()=>y("GET","/contracts/connect/account-status"),staleTime:1e3*60*10,gcTime:1e3*60*30}),M=V({mutationFn:()=>y("POST","/contracts/connect/create-account"),onSuccess:()=>{T.invalidateQueries({queryKey:["/contracts/connect/account-status"]})}}),D=V({mutationFn:()=>y("POST","/contracts/connect/create-onboarding-link"),onSuccess:s=>{window.location.href=s.url}}),w=async()=>{f!=null&&f.has_account||await M.mutateAsync(),D.mutate()},[X,n]=h.useState(!1),[r,m]=h.useState(!1),[L,K]=h.useState(null),Y=s=>{var A;const x=(A=s.target.files)==null?void 0:A[0];if(!x)return;if(!x.type.startsWith("image/")){o({title:"Erreur",description:"Le fichier doit être une image",variant:"destructive"});return}const v=new FileReader;v.onload=()=>{K(v.result),m(!0)},v.onerror=()=>{o({title:"Erreur",description:"Erreur lors de la lecture du fichier",variant:"destructive"})},v.readAsDataURL(x)},le=async s=>{n(!0);try{const x=new File([s],"profile-picture.png",{type:"image/png",lastModified:Date.now()}),A=(await Ye(x)).url;await ue.mutateAsync({profile_picture:A}),o({title:"Succès",description:"Photo de profil mise à jour"})}catch(x){o({title:"Erreur",description:x instanceof Error?x.message:"Erreur lors de l'upload de la photo",variant:"destructive"})}finally{n(!1),K(null)}},De=V({mutationFn:s=>y("DELETE",`/properties/${s}`),onSuccess:()=>{T.invalidateQueries({queryKey:["/properties/my-properties"]})}}),ue=V({mutationFn:s=>y("PUT","/users/profile",s),onSuccess:async()=>{T.invalidateQueries({queryKey:["/auth/profile"]}),T.invalidateQueries({queryKey:["/auth/user"]}),await E(),o({title:"Success",description:"Profile updated successfully"})},onError:s=>{o({title:"Error",description:s.message,variant:"destructive"})}}),Le=V({mutationFn:s=>y("PUT","/users/change-password",s),onSuccess:()=>{o({title:"Success",description:"Password changed successfully"})},onError:s=>{o({title:"Error",description:s.message,variant:"destructive"})}});return e.jsx(Re,{children:e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2","data-testid":"text-dashboard-title",children:t("dashboard.owner.welcome",{name:(a==null?void 0:a.first_name)||""})}),e.jsx("p",{className:"text-muted-foreground",children:t("dashboard.owner.manage")})]}),f&&!f.onboarding_complete&&e.jsxs(G,{className:"mb-6",children:[e.jsx(We,{className:"h-4 w-4"}),e.jsxs(W,{children:[t("dashboard.stripe.setup"),e.jsx(l,{variant:"ghost",className:"ml-2 p-0 h-auto",onClick:w,disabled:M.isPending||D.isPending,"data-testid":"button-setup-stripe",children:M.isPending||D.isPending?t("dashboard.stripe.setting"):t("dashboard.stripe.setup.button")})]})]}),e.jsxs(Ie,{value:P,onValueChange:k,className:"space-y-6",children:[e.jsxs(Oe,{className:"grid w-full grid-cols-5 lg:w-auto lg:inline-grid",children:[e.jsxs(Z,{value:"properties",className:"gap-2","data-testid":"tab-properties",children:[e.jsx(oe,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.properties")})]}),e.jsxs(Z,{value:"requests",className:"gap-2","data-testid":"tab-requests",children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.requests")})]}),e.jsxs(Z,{value:"contracts",className:"gap-2","data-testid":"tab-contracts",children:[e.jsx(Pe,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.contracts")})]}),e.jsxs(Z,{value:"messages",className:"gap-2","data-testid":"tab-messages",children:[e.jsx(xe,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.messages")})]}),e.jsxs(Z,{value:"profile",className:"gap-2","data-testid":"tab-profile",children:[e.jsx(Xe,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Profile"})]})]}),e.jsxs(ee,{value:"properties",className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:t("dashboard.properties")}),e.jsx("p",{className:"text-muted-foreground",children:t("dashboard.properties.desc")})]}),e.jsx(J,{href:"/properties/create",children:e.jsxs(l,{"data-testid":"button-add-property",children:[e.jsx(Te,{className:"h-4 w-4 mr-2"}),t("dashboard.properties.add")]})})]}),d?e.jsxs(_,{className:"p-12 text-center",children:[e.jsx(ie,{className:"h-12 w-12 text-destructive mx-auto mb-4"}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:"Erreur de chargement"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:d instanceof Error?d.message:"Impossible de charger les propriétés"}),e.jsx(l,{onClick:()=>window.location.reload(),children:"Recharger la page"})]}):j?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[1,2,3].map(s=>e.jsx(ae,{className:"h-96 w-full"},s))}):!p||p.length===0?e.jsxs(_,{className:"p-12 text-center",children:[e.jsx(oe,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:t("dashboard.properties.empty")}),e.jsx("p",{className:"text-muted-foreground mb-4",children:t("dashboard.properties.empty.desc")}),e.jsx(J,{href:"/properties/create",children:e.jsxs(l,{children:[e.jsx(Te,{className:"h-4 w-4 mr-2"}),t("dashboard.properties.empty.button")]})})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:p.map(s=>e.jsxs("div",{className:"relative",children:[e.jsx(ze,{property:s,hideFavoriteButton:!0}),e.jsxs("div",{className:"absolute top-3 right-3 flex gap-2 z-50",children:[e.jsx(J,{href:`/properties/${s.id}/edit`,children:e.jsx(l,{size:"icon",variant:"secondary",className:"bg-background/90 backdrop-blur shadow-md hover:shadow-lg","data-testid":`button-edit-${s.id}`,children:e.jsx(es,{className:"h-4 w-4"})})}),e.jsx(l,{size:"icon",variant:"secondary",className:"bg-background/90 backdrop-blur hover:bg-destructive hover:text-destructive-foreground shadow-md hover:shadow-lg",onClick:()=>{confirm("Are you sure you want to delete this property?")&&De.mutate(s.id)},"data-testid":`button-delete-${s.id}`,children:e.jsx(He,{className:"h-4 w-4"})})]})]},s.id))})]}),e.jsx(ee,{value:"requests",className:"space-y-4",children:e.jsxs(_,{children:[e.jsxs(O,{children:[e.jsx(B,{children:"Rental Requests"}),e.jsx($,{children:"Manage applications from students"})]}),e.jsx(q,{children:R?e.jsx("div",{className:"space-y-4",children:[1,2].map(s=>e.jsx(ae,{className:"h-32 w-full"},s))}):!c||c.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Ee,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:"No requests yet"}),e.jsx("p",{className:"text-muted-foreground",children:"Applications will appear here"})]}):e.jsx("div",{className:"space-y-4",children:c.map(s=>e.jsx(_,{children:e.jsxs(q,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-lg",children:s.property_title}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-2",children:["From: ",Ue(s)]}),e.jsxs("p",{className:"text-sm bg-muted p-3 rounded-md",children:['"',s.message,'"']})]}),e.jsx(C,{variant:s.status==="accepted"?"default":s.status==="pending"?"secondary":"destructive",children:s.status})]}),s.status==="pending"&&e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>i.mutate({id:s.id,status:"rejected"}),disabled:i.isPending,children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),t("dashboard.request.reject")]}),e.jsxs(l,{size:"sm",onClick:()=>i.mutate({id:s.id,status:"accepted"}),disabled:i.isPending,children:[e.jsx(Je,{className:"h-4 w-4 mr-2"}),t("dashboard.request.accept")]})]})]})},s.id))})})]})}),e.jsx(ee,{value:"contracts",className:"space-y-4",children:e.jsxs(_,{children:[e.jsxs(O,{children:[e.jsx(B,{children:"Rental Contracts"}),e.jsx($,{children:"Manage your rental agreements"})]}),e.jsx(q,{children:ne?e.jsx("div",{className:"space-y-4",children:[1,2].map(s=>e.jsx(ae,{className:"h-32 w-full"},s))}):!U||U.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Pe,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:"No contracts yet"}),e.jsx("p",{className:"text-muted-foreground",children:"Your rental contracts will appear here"})]}):e.jsx("div",{className:"space-y-4",children:U.map(s=>e.jsx(_,{"data-testid":`card-contract-${s.id}`,children:e.jsxs(q,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-lg",children:s.property_title}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Tenant: ",s.student_deleted_at?`deleted_user_${s.student_id}`:`${s.student_first_name||""} ${s.student_last_name||""}`.trim()]})]}),e.jsx(C,{variant:s.status==="active"?"default":s.status==="pending"?"secondary":"outline",children:s.status})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Monthly Rent"}),e.jsxs("p",{className:"font-semibold",children:["CHF ",s.monthly_rent.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Your Payout"}),e.jsxs("p",{className:"font-semibold",children:["CHF ",s.owner_payout.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Duration"}),e.jsxs("p",{className:"font-semibold",children:[new Date(s.start_date).toLocaleDateString()," - ",new Date(s.end_date).toLocaleDateString()]})]})]}),e.jsx(J,{href:`/contracts/${s.id}`,children:e.jsx(l,{variant:"outline",size:"sm",children:t("dashboard.contract.view")})})]})},s.id))})})]})}),e.jsx(ee,{value:"messages",className:"space-y-4",children:e.jsxs(_,{children:[e.jsxs(O,{children:[e.jsx(B,{children:"Conversations"}),e.jsx($,{children:"Messages with potential tenants"})]}),e.jsx(q,{children:de?e.jsx("div",{className:"space-y-4",children:[1,2,3].map(s=>e.jsx(ae,{className:"h-20 w-full"},s))}):!Q||Q.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(xe,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:"No messages yet"}),e.jsx("p",{className:"text-muted-foreground",children:"Student inquiries will appear here"})]}):e.jsx("div",{className:"space-y-3",children:Q.map(s=>e.jsx(J,{href:`/messages?conversation=${s.id}`,children:e.jsx(_,{className:"hover-elevate cursor-pointer",children:e.jsxs(q,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-md bg-muted flex items-center justify-center flex-shrink-0",children:e.jsx(oe,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold truncate",children:s.property_title}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.other_user_name}),s.last_message&&e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.last_message})]}),s.unread_count&&s.unread_count>0&&e.jsx(C,{variant:"default",children:s.unread_count})]})})},s.id))})})]})}),e.jsxs(ee,{value:"profile",className:"space-y-4",children:[e.jsxs(_,{children:[e.jsxs(O,{children:[e.jsx(B,{children:"Profile Information"}),e.jsx($,{children:"Your account details"})]}),e.jsxs(q,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4 pb-4 border-b",children:[e.jsxs(Me,{className:"h-24 w-24",children:[e.jsx(Ke,{src:a!=null&&a.profile_picture?te(a.profile_picture):void 0}),e.jsxs(Ve,{className:"bg-primary text-primary-foreground text-2xl",children:[(he=a==null?void 0:a.first_name)==null?void 0:he[0],(pe=a==null?void 0:a.last_name)==null?void 0:pe[0]]})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx(I,{htmlFor:"profile-picture-upload",className:"cursor-pointer",children:e.jsx(l,{variant:"outline",asChild:!0,disabled:X,children:e.jsxs("span",{children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),X?"Upload en cours...":"Changer la photo de profil"]})})}),e.jsx(z,{id:"profile-picture-upload",type:"file",accept:"image/*",className:"hidden",onChange:Y,disabled:X}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Formats acceptés: JPG, PNG, WEBP (max 10 MB)"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.first_name")}),e.jsx("p",{className:"font-medium",children:a==null?void 0:a.first_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.last_name")}),e.jsx("p",{className:"font-medium",children:a==null?void 0:a.last_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.email")}),e.jsx("p",{className:"font-medium",children:a==null?void 0:a.email})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.phone")}),e.jsx("p",{className:"font-medium",children:(a==null?void 0:a.phone)||t("dashboard.phone.not_provided")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.account_type")}),e.jsx(C,{children:a==null?void 0:a.role})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.email_verified")}),e.jsx(C,{variant:a!=null&&a.email_verified?"default":"secondary",children:a!=null&&a.email_verified?t("dashboard.profile.verified"):t("dashboard.profile.not_verified")})]})]}),e.jsx(je,{}),e.jsx(as,{user:a,updateProfileMutation:ue,changePasswordMutation:Le,onPhotoUpload:Y}),e.jsx(je,{}),f&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Payment Setup"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Stripe Account"}),e.jsx(C,{variant:f.has_account?"default":"secondary",children:f.has_account?"Connected":"Not Connected"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Onboarding"}),e.jsx(C,{variant:f.onboarding_complete?"default":"secondary",children:f.onboarding_complete?"Complete":"Incomplete"})]}),f.payouts_enabled!==void 0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Payouts"}),e.jsx(C,{variant:f.payouts_enabled?"default":"secondary",children:f.payouts_enabled?"Enabled":"Disabled"})]})]}),!f.onboarding_complete&&e.jsx(l,{className:"mt-4",onClick:w,disabled:M.isPending||D.isPending,children:M.isPending||D.isPending?"Setting up...":"Complete Stripe Setup"})]})]})]}),e.jsx(ss,{})]})]}),L&&e.jsx(Ge,{open:r,onClose:()=>{m(!1),K(null)},imageSrc:L,onCropComplete:le,aspectRatio:1,circularCrop:!0})]})})}function as({user:a,updateProfileMutation:g,changePasswordMutation:S,onPhotoUpload:E}){const{t:u}=qe(),[o,t]=h.useState(!1),[P,k]=h.useState(!1),[b,j]=h.useState({first_name:(a==null?void 0:a.first_name)||"",last_name:(a==null?void 0:a.last_name)||"",phone:(a==null?void 0:a.phone)||""}),[d,p]=h.useState({current_password:"",new_password:"",confirm_password:""});h.useState(!1);const N=()=>{g.mutate(b),t(!1)},R=()=>{d.new_password===d.confirm_password&&(S.mutate({current_password:d.current_password,new_password:d.new_password}),k(!1),p({current_password:"",new_password:"",confirm_password:""}))};return e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Account Settings"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(fe,{open:o,onOpenChange:t,children:[e.jsx(ge,{asChild:!0,children:e.jsx(l,{variant:"outline",children:"Edit Profile"})}),e.jsxs(ve,{children:[e.jsxs(be,{children:[e.jsx(Ne,{children:"Edit Profile"}),e.jsx(we,{children:"Update your personal information"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsx(I,{htmlFor:"first_name",children:u("dashboard.profile.first_name")}),e.jsx(z,{id:"first_name",value:b.first_name,onChange:c=>j({...b,first_name:c.target.value})})]}),e.jsxs("div",{children:[e.jsx(I,{htmlFor:"last_name",children:u("dashboard.profile.last_name")}),e.jsx(z,{id:"last_name",value:b.last_name,onChange:c=>j({...b,last_name:c.target.value})})]}),e.jsxs("div",{children:[e.jsx(I,{htmlFor:"phone",children:u("dashboard.profile.phone")}),e.jsx(z,{id:"phone",value:b.phone,onChange:c=>j({...b,phone:c.target.value})})]})]}),e.jsxs(ye,{children:[e.jsx(l,{variant:"outline",onClick:()=>t(!1),children:"Cancel"}),e.jsx(l,{onClick:N,disabled:g.isPending,children:g.isPending?"Saving...":"Save Changes"})]})]})]}),e.jsxs(fe,{open:P,onOpenChange:k,children:[e.jsx(ge,{asChild:!0,children:e.jsxs(l,{variant:"outline",children:[e.jsx(Ze,{className:"h-4 w-4 mr-2"}),u("dashboard.profile.change_password")]})}),e.jsxs(ve,{children:[e.jsxs(be,{children:[e.jsx(Ne,{children:u("dashboard.profile.change_password")}),e.jsx(we,{children:u("dashboard.profile.change_password.desc")})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsx(I,{htmlFor:"current_password",children:u("dashboard.profile.current_password")}),e.jsx(z,{id:"current_password",type:"password",value:d.current_password,onChange:c=>p({...d,current_password:c.target.value})})]}),e.jsxs("div",{children:[e.jsx(I,{htmlFor:"new_password",children:u("dashboard.profile.new_password")}),e.jsx(z,{id:"new_password",type:"password",value:d.new_password,onChange:c=>p({...d,new_password:c.target.value})})]}),e.jsxs("div",{children:[e.jsx(I,{htmlFor:"confirm_password",children:u("dashboard.profile.confirm_password")}),e.jsx(z,{id:"confirm_password",type:"password",value:d.confirm_password,onChange:c=>p({...d,confirm_password:c.target.value})}),d.new_password&&d.confirm_password&&d.new_password!==d.confirm_password&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:"Passwords do not match"})]})]}),e.jsxs(ye,{children:[e.jsx(l,{variant:"outline",onClick:()=>k(!1),children:u("common.cancel")}),e.jsx(l,{onClick:R,disabled:S.isPending||d.new_password!==d.confirm_password,children:S.isPending?u("dashboard.profile.changing"):u("dashboard.profile.change_password")})]})]})]})]})]})})}export{Ds as default};
