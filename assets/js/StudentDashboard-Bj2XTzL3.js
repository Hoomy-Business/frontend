import{u as T,b as k,j as e}from"./query-vendor-CNIykozp.js";import{u as ne,r as p,L as j}from"./react-vendor-DdYNpgPf.js";import{M as ce,e as H,A as oe,b as me,n as xe,d as he}from"./MainLayout-BqPj5A1Q.js";import{P as ue}from"./slider-CMEQ17eX.js";import{B as n}from"./button-B8zoFJtu.js";import{C as i,b as f,c as g,d as N,a as l}from"./card-BTGRRs4F.js";import{T as pe,a as je,b as v,c as b}from"./tabs-BBkwLvPp.js";import{B as y}from"./badge-BSblSpJG.js";import{a as fe,h as ge,u as Ne,q as w,S as _,X as ve,l as be,b as x,g as ye,f as we}from"./index-Co9HXm8e.js";import{A as Ce,a as Te}from"./alert-pa1NVYRn.js";import{I as _e}from"./input-CYFS7xjh.js";import{L as Ee}from"./label-BAS4UUYP.js";import{I as O,C as Le,a as Se}from"./ImageCropDialog-DWG0Zjw7.js";import{S as E}from"./sparkles-DTDwz1YV.js";import{T as qe}from"./trending-up-DktijrWP.js";import{H as B}from"./heart-C5VARFXK.js";import{F as R}from"./file-text-BwWXl-J0.js";import{U as Fe}from"./user-70LQggi4.js";import{B as V}from"./building-2-io5-MBU8.js";import{C as Ae}from"./circle-check-AfJv8YAO.js";import{C as De}from"./clock-oaXuBoZ4.js";import"./Logo-Bhe2__w3.js";import"./ui-vendor-BME24-VV.js";import"./map-pin-DSbG-QSc.js";import"./dialog-CiwGFzKL.js";import"./maximize-Be3afR8P.js";function ds(){var z,$;const{user:a,isAuthenticated:L,isStudent:S,refreshUser:W}=fe(),[,C]=ne();p.useEffect(()=>{if(!L){C("/login");return}S||((a==null?void 0:a.role)==="admin"?C("/admin/dashboard"):C("/dashboard/owner"))},[L,S,a==null?void 0:a.role,C]);const{toast:d}=ge(),{t}=Ne(),[J,X]=p.useState("favorites"),{data:c,isLoading:Y,error:q}=T({queryKey:["/favorites"],enabled:L&&S,retry:!1,queryFn:async()=>{const s=ye();if(!s)throw new Error("No authentication token");const r={Authorization:`Bearer ${s}`},le=`${we().replace(/\/+$/,"")}/favorites`,u=await fetch(le,{headers:r});if(!u.ok){const G=await u.json().catch(()=>({error:u.statusText}));throw new Error(G.error||G.message||u.statusText)}const Q=await u.json();return Array.isArray(Q)?Q:[]},staleTime:1e3*60*5,gcTime:1e3*60*15}),{data:o,isLoading:Z}=T({queryKey:["/contracts/my-contracts"],queryFn:async()=>x("GET","/contracts/my-contracts"),select:s=>(s==null?void 0:s.contracts)||[],staleTime:1e3*60*5,gcTime:1e3*60*15}),{data:F,isLoading:ee}=T({queryKey:["/conversations"],queryFn:async()=>x("GET","/conversations"),staleTime:1e3*30,gcTime:1e3*60*5}),se=k({mutationFn:s=>x("DELETE",`/favorites/${s}`),onSuccess:()=>{w.invalidateQueries({queryKey:["/favorites"]})}}),{data:A,isLoading:ae}=T({queryKey:["/requests/sent"],queryFn:async()=>x("GET","/requests/sent"),staleTime:1e3*30,gcTime:1e3*60*5}),U=k({mutationFn:s=>x("DELETE",`/requests/${s}`),onSuccess:()=>{w.invalidateQueries({queryKey:["/requests/sent"]}),d({title:"Success",description:"Request cancelled successfully"})},onError:s=>{d({title:"Error",description:s.message,variant:"destructive"})}}),te=k({mutationFn:s=>x("PUT","/users/profile",s),onSuccess:async()=>{w.invalidateQueries({queryKey:["/auth/profile"]}),w.invalidateQueries({queryKey:["/auth/user"]}),await W(),d({title:"Success",description:"Profile updated successfully"})},onError:s=>{d({title:"Error",description:s.message,variant:"destructive"})}}),[D,I]=p.useState(!1),[re,M]=p.useState(!1),[K,P]=p.useState(null),ie=s=>{var h;const r=(h=s.target.files)==null?void 0:h[0];if(!r)return;if(!r.type.startsWith("image/")){d({title:"Erreur",description:"Le fichier doit être une image",variant:"destructive"});return}const m=new FileReader;m.onload=()=>{P(m.result),M(!0)},m.onerror=()=>{d({title:"Erreur",description:"Erreur lors de la lecture du fichier",variant:"destructive"})},m.readAsDataURL(r)},de=async s=>{I(!0);try{const r=new File([s],"profile-picture.png",{type:"image/png",lastModified:Date.now()}),h=(await be(r)).url;await te.mutateAsync({profile_picture:h}),d({title:"Succès",description:"Photo de profil mise à jour"})}catch(r){d({title:"Erreur",description:r instanceof Error?r.message:"Erreur lors de l'upload de la photo",variant:"destructive"})}finally{I(!1),P(null)}};return e.jsx(ce,{children:e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl md:text-4xl font-bold mb-2 flex items-center gap-3","data-testid":"text-dashboard-title",children:[e.jsx(E,{className:"h-7 w-7 text-primary"}),t("dashboard.student.welcome",{name:(a==null?void 0:a.first_name)||""})]}),e.jsxs("p",{className:"text-muted-foreground flex items-center gap-2",children:[e.jsx(qe,{className:"h-4 w-4"}),t("dashboard.student.manage")]})]}),e.jsxs("div",{className:"hidden md:flex gap-3",children:[c&&c.length>0&&e.jsx(i,{className:"px-4 py-2 border-primary/20",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-4 w-4 text-primary"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Favoris"}),e.jsx("div",{className:"text-lg font-bold",children:c.length})]})]})}),o&&o.length>0&&e.jsx(i,{className:"px-4 py-2 border-primary/20",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-primary"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Contrats"}),e.jsx("div",{className:"text-lg font-bold",children:o.length})]})]})})]})]})}),e.jsxs(pe,{value:J,onValueChange:X,className:"space-y-6",children:[e.jsxs(je,{className:"grid w-full grid-cols-5 lg:w-auto lg:inline-grid",children:[e.jsxs(v,{value:"favorites",className:"gap-2","data-testid":"tab-favorites",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.student.favorites")})]}),e.jsxs(v,{value:"requests",className:"gap-2","data-testid":"tab-requests",children:[e.jsx(O,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.student.requests")})]}),e.jsxs(v,{value:"messages",className:"gap-2","data-testid":"tab-messages",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.student.messages")})]}),e.jsxs(v,{value:"contracts",className:"gap-2","data-testid":"tab-contracts",children:[e.jsx(R,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.student.contracts")})]}),e.jsxs(v,{value:"profile",className:"gap-2","data-testid":"tab-profile",children:[e.jsx(Fe,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.profile.title")})]})]}),e.jsx(b,{value:"favorites",className:"space-y-4",children:e.jsxs(i,{children:[e.jsxs(f,{children:[e.jsx(g,{children:t("dashboard.student.favorites")}),e.jsx(N,{children:t("dashboard.student.favorites.desc")})]}),e.jsx(l,{children:q?e.jsx(Ce,{variant:"destructive",className:"mb-4",children:e.jsx(Te,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold mb-1",children:"Erreur de chargement"}),e.jsx("p",{className:"text-sm",children:q instanceof Error?q.message:"Erreur inconnue"})]}),e.jsx(n,{variant:"outline",size:"sm",onClick:()=>w.invalidateQueries({queryKey:["/favorites"]}),children:"Réessayer"})]})})}):Y?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[1,2,3].map(s=>e.jsx(_,{className:"h-80 w-full"},s))}):!c||c.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted flex items-center justify-center mx-auto mb-4",children:e.jsx(B,{className:"h-10 w-10 text-muted-foreground"})}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:t("dashboard.student.favorites.empty")}),e.jsx("p",{className:"text-muted-foreground mb-6 max-w-md mx-auto",children:t("dashboard.student.favorites.empty.desc")}),e.jsx(j,{href:"/properties",children:e.jsxs(n,{size:"lg",children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),t("messages.browse")]})})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:c.map(s=>e.jsx(ue,{property:s,isFavorited:!0,onFavoriteToggle:r=>se.mutate(r)},s.id))})})]})}),e.jsx(b,{value:"requests",className:"space-y-4",children:e.jsxs(i,{children:[e.jsxs(f,{children:[e.jsx(g,{children:t("dashboard.student.requests.title")}),e.jsx(N,{children:t("dashboard.student.requests.desc")})]}),e.jsx(l,{children:ae?e.jsx("div",{className:"space-y-4",children:[1,2].map(s=>e.jsx(_,{className:"h-32 w-full"},s))}):!A||A.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted flex items-center justify-center mx-auto mb-4",children:e.jsx(O,{className:"h-10 w-10 text-muted-foreground"})}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:t("dashboard.student.requests.empty")}),e.jsx("p",{className:"text-muted-foreground mb-6 max-w-md mx-auto",children:t("dashboard.student.requests.empty.desc")}),e.jsx(j,{href:"/properties",children:e.jsxs(n,{size:"lg",children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"Browse Properties"]})})]}):e.jsx("div",{className:"space-y-4",children:A.map(s=>{var r;return e.jsx(i,{className:"hover-elevate transition-all",children:e.jsxs(l,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-lg mb-1",children:s.property_title}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-3 flex items-center gap-2",children:[e.jsx(V,{className:"h-3 w-3"}),s.city_name," • CHF ",(r=s.price)==null?void 0:r.toLocaleString(),"/mois"]}),e.jsx("div",{className:"bg-muted/50 p-3 rounded-md border-l-4 border-primary",children:e.jsxs("p",{className:"text-sm italic",children:['"',s.message,'"']})})]}),e.jsxs(y,{variant:s.status==="accepted"?"default":s.status==="pending"?"secondary":"destructive",className:"gap-1",children:[s.status==="accepted"&&e.jsx(Ae,{className:"h-3 w-3"}),s.status==="pending"&&e.jsx(De,{className:"h-3 w-3"}),s.status]})]}),s.status==="pending"&&e.jsx("div",{className:"flex gap-2 justify-end",children:e.jsxs(n,{variant:"outline",size:"sm",onClick:()=>{confirm("Are you sure you want to cancel this request?")&&U.mutate(s.id)},disabled:U.isPending,children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"Cancel Request"]})})]})},s.id)})})})]})}),e.jsx(b,{value:"messages",className:"space-y-4",children:e.jsxs(i,{children:[e.jsxs(f,{children:[e.jsx(g,{children:t("messages.conversations")}),e.jsx(N,{children:t("dashboard.student.messages.desc")})]}),e.jsx(l,{children:ee?e.jsx("div",{className:"space-y-4",children:[1,2,3].map(s=>e.jsx(_,{className:"h-20 w-full"},s))}):!F||F.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted flex items-center justify-center mx-auto mb-4",children:e.jsx(H,{className:"h-10 w-10 text-muted-foreground"})}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:t("dashboard.student.messages.empty")}),e.jsx("p",{className:"text-muted-foreground mb-6 max-w-md mx-auto",children:t("dashboard.student.messages.empty.desc")}),e.jsx(j,{href:"/properties",children:e.jsxs(n,{size:"lg",children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),t("messages.browse")]})})]}):e.jsx("div",{className:"space-y-3",children:F.map(s=>e.jsx(j,{href:`/messages?conversation=${s.id}`,children:e.jsx(i,{className:"hover-elevate cursor-pointer",children:e.jsxs(l,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-md bg-muted flex items-center justify-center flex-shrink-0",children:e.jsx(V,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold truncate",children:s.property_title}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.other_user_name}),s.last_message&&e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.last_message})]}),s.unread_count&&s.unread_count>0&&e.jsx(y,{variant:"default",children:s.unread_count})]})})},s.id))})})]})}),e.jsx(b,{value:"contracts",className:"space-y-4",children:e.jsxs(i,{children:[e.jsxs(f,{children:[e.jsx(g,{children:t("dashboard.student.contracts.title")}),e.jsx(N,{children:t("dashboard.student.contracts.desc")})]}),e.jsx(l,{children:Z?e.jsx("div",{className:"space-y-4",children:[1,2].map(s=>e.jsx(_,{className:"h-32 w-full"},s))}):!o||o.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted flex items-center justify-center mx-auto mb-4",children:e.jsx(R,{className:"h-10 w-10 text-muted-foreground"})}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:t("dashboard.student.contracts.empty")}),e.jsx("p",{className:"text-muted-foreground max-w-md mx-auto",children:t("dashboard.student.contracts.empty.desc")})]}):e.jsx("div",{className:"space-y-4",children:o.map(s=>e.jsx(i,{"data-testid":`card-contract-${s.id}`,children:e.jsxs(l,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-lg",children:s.property_title}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.city_name})]}),e.jsx(y,{variant:s.status==="active"?"default":s.status==="pending"?"secondary":"outline",children:s.status})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Monthly Rent"}),e.jsxs("p",{className:"font-semibold",children:["CHF ",s.monthly_rent.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Duration"}),e.jsxs("p",{className:"font-semibold",children:[new Date(s.start_date).toLocaleDateString()," - ",new Date(s.end_date).toLocaleDateString()]})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(j,{href:`/contracts/${s.id}`,children:e.jsx(n,{variant:"outline",size:"sm",children:"View Details"})})})]})},s.id))})})]})}),e.jsx(b,{value:"profile",className:"space-y-4",children:e.jsxs(i,{children:[e.jsxs(f,{children:[e.jsx(g,{children:t("dashboard.profile.title")}),e.jsx(N,{children:t("dashboard.profile.desc")})]}),e.jsxs(l,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4 pb-4 border-b",children:[e.jsxs(oe,{className:"h-24 w-24",children:[e.jsx(me,{src:a!=null&&a.profile_picture?xe(a.profile_picture):void 0}),e.jsxs(he,{className:"bg-primary text-primary-foreground text-2xl",children:[(z=a==null?void 0:a.first_name)==null?void 0:z[0],($=a==null?void 0:a.last_name)==null?void 0:$[0]]})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Ee,{htmlFor:"profile-picture-upload-student",className:"cursor-pointer",children:e.jsx(n,{variant:"outline",asChild:!0,disabled:D,children:e.jsxs("span",{children:[e.jsx(Le,{className:"h-4 w-4 mr-2"}),D?"Upload en cours...":"Changer la photo de profil"]})})}),e.jsx(_e,{id:"profile-picture-upload-student",type:"file",accept:"image/*",className:"hidden",onChange:ie,disabled:D}),K&&e.jsx(Se,{open:re,onClose:()=>{M(!1),P(null)},imageSrc:K,onCropComplete:de,aspectRatio:1,circularCrop:!0}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Formats acceptés: JPG, PNG, WEBP (max 10 MB)"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.first_name")}),e.jsx("p",{className:"font-medium",children:a==null?void 0:a.first_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.last_name")}),e.jsx("p",{className:"font-medium",children:a==null?void 0:a.last_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.email")}),e.jsx("p",{className:"font-medium",children:a==null?void 0:a.email})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.phone")}),e.jsx("p",{className:"font-medium",children:(a==null?void 0:a.phone)||t("dashboard.phone.not_provided")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.account_type")}),e.jsx(y,{children:a==null?void 0:a.role})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.email_verified")}),e.jsx(y,{variant:a!=null&&a.email_verified?"default":"secondary",children:a!=null&&a.email_verified?t("dashboard.profile.verified"):t("dashboard.profile.not_verified")})]})]})]})]})})]})]})})}export{ds as default};
