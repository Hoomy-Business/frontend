import{u as P,b as ae,j as e}from"./query-vendor-CNIykozp.js";import{u as oe,r as N,L as E}from"./react-vendor-DdYNpgPf.js";import{u as ne,F as le,a as c,b as d,c as m,d as u,e as h,f as ie,t as ce,g as de}from"./schema-Dj5CwbO7.js";import{M as O,C as me}from"./MainLayout-Dp07w-_I.js";import{B as f}from"./button-B-ZelJyK.js";import{I as g}from"./input-CHDUk6Su.js";import{T as ue}from"./textarea-7vaoHLUY.js";import{C as he,b as xe,c as pe,d as je,a as ge}from"./card-ChNshBDf.js";import{S as M,a as B,b as V,c as q,d as y}from"./select-BSws-9Mr.js";import{A as K,a as H}from"./alert-OxPXOA7-.js";import{d as ve,a as be,u as fe,X as ye,n as we,b as z}from"./index-BSTG6X_D.js";import{A as Ce}from"./arrow-left-BamUN_qc.js";import{C as Ne}from"./circle-alert-8bZ1axar.js";import{U as Fe}from"./upload-DG2RZKn9.js";import"./ui-vendor-BME24-VV.js";import"./label-U3gdjbGY.js";import"./Logo-DzEVBPy7.js";import"./user-CmdIW5DY.js";import"./building-2-D677uz5C.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=ve("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);function Ke(){const[,W]=oe(),{isOwner:T}=be(),{getCantonName:X,getCityName:Y}=fe(),[D,i]=N.useState(""),[a,R]=N.useState([]);N.useState([]);const[_,J]=N.useState(""),[x,v]=N.useState(0),{data:I}=P({queryKey:["/locations/cantons"],queryFn:async()=>z("GET","/locations/cantons")}),{data:L}=P({queryKey:["/locations/cities",_],enabled:!!_,queryFn:async()=>{if(!_)throw new Error("Canton required");return z("GET",`/locations/cities?canton=${_}`)}}),{data:w}=P({queryKey:["/kyc/status"],queryFn:async()=>z("GET","/kyc/status"),enabled:T}),o=ne({resolver:ce(de),defaultValues:{title:"",description:"",property_type:"apartment",address:"",city_name:"",postal_code:"",canton_code:"",price:0,rooms:void 0,bathrooms:void 0,surface_area:void 0,available_from:""}}),A=ae({mutationFn:async r=>{const s=r.image_urls||r.photos||[];if(!s||s.length===0)throw new Error("Au moins une image est requise");const t={...r,image_urls:s};return delete t.photos,z("POST","/properties",t)},onSuccess:()=>{W("/dashboard/owner")},onError:r=>{i(r.message||"Failed to create property")}}),k=10*1024*1024,Q=(r,s=1920,t=1920,n=.85)=>new Promise((l,b)=>{const F=new FileReader;F.onload=se=>{var $;const C=new Image;C.onload=()=>{const S=document.createElement("canvas");let p=C.width,j=C.height;(p>s||j>t)&&(p>j?(j=j*s/p,p=s):(p=p*t/j,j=t)),S.width=p,S.height=j;const G=S.getContext("2d");if(!G){b(new Error("Impossible de créer le contexte canvas"));return}G.drawImage(C,0,0,p,j),S.toBlob(U=>{if(!U){b(new Error("Échec de la compression"));return}const te=new File([U],r.name,{type:r.type,lastModified:Date.now()});l(te)},r.type,n)},C.onerror=()=>b(new Error("Erreur lors du chargement de l'image")),C.src=($=se.target)==null?void 0:$.result},F.onerror=()=>b(new Error("Erreur lors de la lecture du fichier")),F.readAsDataURL(r)}),Z=async r=>{if(r.target.files){const s=Array.from(r.target.files);i("");try{const t=[];for(const n of s){if(!n.type.startsWith("image/")){i(`Le fichier "${n.name}" n'est pas une image valide.`);return}let l=n;if(n.size>k)try{if(l=await Q(n),l.size>k){const b=(k/1048576).toFixed(0);i(`L'image "${n.name}" est trop volumineuse même après compression (${(l.size/(1024*1024)).toFixed(1)} MB). La taille maximale est de ${b} MB. Veuillez utiliser une image plus petite.`);return}}catch{const F=(k/1048576).toFixed(0);i(`Impossible de compresser "${n.name}". Veuillez réduire manuellement la taille de l'image (max ${F} MB).`);return}t.push(l)}t.length>0&&R(n=>[...n,...t])}catch(t){i("Erreur lors du traitement des fichiers: "+(t instanceof Error?t.message:"Erreur inconnue"))}}},ee=r=>{R(s=>{const t=s.filter((n,l)=>l!==r);return x>=t.length&&t.length>0?v(t.length-1):t.length===0&&v(0),t})};N.useEffect(()=>{x>=a.length&&a.length>0?v(a.length-1):a.length===0&&v(0)},[a.length,x]);const re=async r=>{if(i(""),!r.address||!r.city_name||!r.postal_code||!r.canton_code){i("Veuillez remplir tous les champs d'adresse (rue, canton, ville, code postal)");return}if(a.length===0){i("Au moins une image est requise");return}let s=[];try{if(s=(await we(a)).images.map(l=>l.url),!s||s.length===0){i("Échec du téléchargement des images");return}}catch(n){const l=n instanceof Error?n.message:"Erreur inconnue";i("Échec du téléchargement des images: "+l),(l.includes("trop volumineux")||l.includes("File too large"))&&i("Échec du téléchargement des images: Les fichiers sont trop volumineux. La taille maximale est de 10 MB par image. Veuillez compresser ou réduire la taille de vos images avant de les uploader.");return}const t={...r,rooms:r.rooms??void 0,bathrooms:r.bathrooms??void 0,surface_area:r.surface_area??void 0,available_from:r.available_from||null,image_urls:s};A.mutate(t)};return T?e.jsx(O,{children:e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx(E,{href:"/dashboard/owner",children:e.jsxs(f,{variant:"ghost",className:"mb-4",children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Back to Dashboard"]})}),e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs(he,{children:[e.jsxs(xe,{children:[e.jsx(pe,{children:"Add New Property"}),e.jsx(je,{children:"Fill in the details of your property listing"})]}),e.jsxs(ge,{children:[D&&e.jsx(K,{variant:"destructive",className:"mb-4",children:e.jsx(H,{children:D})}),w&&!w.is_verified&&!w.kyc_verified&&e.jsxs(K,{className:"mb-4 border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20",children:[e.jsx(Ne,{className:"h-4 w-4 text-yellow-600"}),e.jsxs(H,{className:"text-yellow-800 dark:text-yellow-200",children:[e.jsx("strong",{children:"Vérification KYC requise"}),e.jsx("br",{}),"Vous devez compléter la vérification KYC avant de pouvoir publier des annonces.",e.jsx("br",{}),e.jsx(E,{href:"/dashboard/owner?tab=profile",className:"underline font-medium mt-2 inline-block",children:"Compléter la vérification dans votre profil"})]})]}),e.jsx(le,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(re),className:"space-y-6",children:[e.jsx(c,{control:o.control,name:"title",render:({field:r})=>e.jsxs(d,{children:[e.jsx(m,{children:"Property Title"}),e.jsx(u,{children:e.jsx(g,{...r,placeholder:"Cozy 2-room apartment near university","data-testid":"input-title"})}),e.jsx(h,{})]})}),e.jsx(c,{control:o.control,name:"description",render:({field:r})=>e.jsxs(d,{children:[e.jsx(m,{children:"Description"}),e.jsx(u,{children:e.jsx(ue,{...r,placeholder:"Describe your property, amenities, nearby facilities...",rows:6,className:"resize-none","data-testid":"input-description"})}),e.jsx(ie,{children:"Minimum 20 caractères avec plusieurs mots séparés par des espaces"}),e.jsx(h,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(c,{control:o.control,name:"property_type",render:({field:r})=>e.jsxs(d,{children:[e.jsx(m,{children:"Property Type"}),e.jsxs(M,{onValueChange:r.onChange,value:r.value,children:[e.jsx(u,{children:e.jsx(B,{"data-testid":"select-type",children:e.jsx(V,{})})}),e.jsxs(q,{children:[e.jsx(y,{value:"apartment",children:"Apartment"}),e.jsx(y,{value:"house",children:"House"}),e.jsx(y,{value:"studio",children:"Studio"}),e.jsx(y,{value:"room",children:"Room"}),e.jsx(y,{value:"other",children:"Other"})]})]}),e.jsx(h,{})]})}),e.jsx(c,{control:o.control,name:"price",render:({field:r})=>e.jsxs(d,{children:[e.jsx(m,{children:"Monthly Rent (CHF)"}),e.jsx(u,{children:e.jsx(g,{...r,type:"number",placeholder:"1500",value:r.value||"",onChange:s=>{const t=s.target.value;r.onChange(t===""?void 0:parseFloat(t)||void 0)},"data-testid":"input-price"})}),e.jsx(h,{})]})})]}),e.jsx(c,{control:o.control,name:"address",render:({field:r})=>e.jsxs(d,{children:[e.jsx(m,{children:"Street Address"}),e.jsx(u,{children:e.jsx(g,{...r,placeholder:"Entrez une adresse","data-testid":"input-address"})}),e.jsx(h,{})]})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(c,{control:o.control,name:"canton_code",render:({field:r})=>e.jsxs(d,{children:[e.jsx(m,{children:"Canton"}),e.jsxs(M,{onValueChange:s=>{r.onChange(s),J(s),o.setValue("city_name",""),o.setValue("address","")},value:r.value,children:[e.jsx(u,{children:e.jsx(B,{"data-testid":"select-canton",children:e.jsx(V,{placeholder:"Select"})})}),e.jsx(q,{children:I==null?void 0:I.map(s=>e.jsx(y,{value:s.code,children:X(s)},s.code))})]}),e.jsx(h,{})]})}),e.jsx(c,{control:o.control,name:"city_name",render:({field:r})=>e.jsxs(d,{children:[e.jsx(m,{children:"City"}),e.jsxs(M,{onValueChange:r.onChange,value:r.value,children:[e.jsx(u,{children:e.jsx(B,{"data-testid":"select-city",children:e.jsx(V,{placeholder:"Select"})})}),e.jsx(q,{children:L==null?void 0:L.map(s=>e.jsx(y,{value:s.name,children:Y(s.name)},s.id))})]}),e.jsx(h,{})]})}),e.jsx(c,{control:o.control,name:"postal_code",render:({field:r})=>e.jsxs(d,{children:[e.jsx(m,{children:"Postal Code"}),e.jsx(u,{children:e.jsx(g,{...r,placeholder:"8001",maxLength:4,"data-testid":"input-postal"})}),e.jsx(h,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(c,{control:o.control,name:"rooms",render:({field:r})=>e.jsxs(d,{children:[e.jsx(m,{children:"Rooms"}),e.jsx(u,{children:e.jsx(g,{...r,type:"number",step:"0.5",placeholder:"2.5",value:r.value||"",onChange:s=>{const t=s.target.value;r.onChange(t===""?void 0:parseFloat(t)||void 0)},"data-testid":"input-rooms"})}),e.jsx(h,{})]})}),e.jsx(c,{control:o.control,name:"bathrooms",render:({field:r})=>e.jsxs(d,{children:[e.jsx(m,{children:"Bathrooms"}),e.jsx(u,{children:e.jsx(g,{...r,type:"number",placeholder:"1",value:r.value||"",onChange:s=>{const t=s.target.value;r.onChange(t===""?void 0:parseInt(t)||void 0)},"data-testid":"input-bathrooms"})}),e.jsx(h,{})]})}),e.jsx(c,{control:o.control,name:"surface_area",render:({field:r})=>e.jsxs(d,{children:[e.jsx(m,{children:"Surface (m²)"}),e.jsx(u,{children:e.jsx(g,{...r,type:"number",placeholder:"65",value:r.value||"",onChange:s=>{const t=s.target.value;r.onChange(t===""?void 0:parseInt(t)||void 0)},"data-testid":"input-surface"})}),e.jsx(h,{})]})})]}),e.jsx(c,{control:o.control,name:"available_from",render:({field:r})=>e.jsxs(d,{children:[e.jsx(m,{children:"Available From (Optional)"}),e.jsx(u,{children:e.jsx(g,{...r,type:"date","data-testid":"input-available"})}),e.jsx(h,{})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Property Photos"}),e.jsxs("div",{className:"border-2 border-dashed rounded-md p-8 text-center",children:[e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:Z,className:"hidden",id:"file-upload"}),e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer",children:[e.jsx(Fe,{className:"h-8 w-8 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Click to upload or drag and drop"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"PNG, JPG, WEBP up to 10MB"})]})]}),a.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"relative aspect-video rounded-lg overflow-hidden bg-muted border-2 border-border group",children:[e.jsx("img",{src:URL.createObjectURL(a[x]),alt:`Preview ${x+1}`,className:"w-full h-full object-cover"}),e.jsx(f,{type:"button",size:"icon",variant:"destructive",className:"absolute top-2 right-2 z-10",onClick:()=>{ee(x)},children:e.jsx(ye,{className:"h-4 w-4"})}),e.jsxs("div",{className:"absolute bottom-2 left-2 bg-black/70 text-white px-3 py-1.5 rounded-md text-sm font-medium z-10",children:[x+1," / ",a.length]}),a.length>1&&e.jsx(f,{type:"button",size:"icon",variant:"secondary",className:"absolute left-2 top-1/2 -translate-y-1/2 z-20 bg-black/40 hover:bg-black/70 backdrop-blur-sm text-white border-0 shadow-lg h-10 w-10 rounded-full transition-all hover:scale-110 active:scale-95 group-hover:bg-black/70",onClick:()=>{v(r=>r===0?a.length-1:r-1)},"aria-label":"Image précédente",children:e.jsx(_e,{className:"h-5 w-5",strokeWidth:2.5})}),a.length>1&&e.jsx(f,{type:"button",size:"icon",variant:"secondary",className:"absolute right-2 top-1/2 -translate-y-1/2 z-20 bg-black/40 hover:bg-black/70 backdrop-blur-sm text-white border-0 shadow-lg h-10 w-10 rounded-full transition-all hover:scale-110 active:scale-95 group-hover:bg-black/70",onClick:()=>{v(r=>r===a.length-1?0:r+1)},"aria-label":"Image suivante",children:e.jsx(me,{className:"h-5 w-5",strokeWidth:2.5})})]}),a.length>1&&e.jsx("div",{className:"flex justify-center gap-2 mt-3",children:a.map((r,s)=>e.jsx("button",{type:"button",onClick:()=>v(s),className:`h-2 rounded-full transition-all ${x===s?"w-8 bg-primary":"w-2 bg-muted-foreground/30 hover:bg-muted-foreground/50"}`,"aria-label":`Go to image ${s+1}`},s))})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(f,{type:"submit",size:"lg",disabled:A.isPending||w&&!w.is_verified&&!w.kyc_verified,className:"flex-1","data-testid":"button-submit",children:A.isPending?"Creating...":"Create Property"}),e.jsx(E,{href:"/dashboard/owner",children:e.jsx(f,{type:"button",variant:"outline",size:"lg",children:"Cancel"})})]})]})})]})]})})]})}):e.jsx(O,{children:e.jsxs("div",{className:"container mx-auto px-4 py-16 text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Access Denied"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Only property owners can create listings"}),e.jsx(E,{href:"/",children:e.jsx(f,{children:"Go Home"})})]})})}export{Ke as default};
