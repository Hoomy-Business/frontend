import{u as A,b as R,j as e}from"./query-vendor-CNIykozp.js";import{u as me,r as p,L as f}from"./react-vendor-DdYNpgPf.js";import{M as xe,e as W,A as he,b as ue,n as pe,d as fe}from"./MainLayout-NmdhbHwr.js";import{P as je}from"./slider-ClMrkBSe.js";import{B as n}from"./button-DFlaW1fX.js";import{C as i,b as j,c as g,d as N,a as l}from"./card-soCmDmm_.js";import{T as ge,a as Ne,b as v,c as b}from"./tabs-JZlzNMbI.js";import{B as y}from"./badge-lbYZ3FY3.js";import{a as ve,h as be,u as ye,q as w,S as T,X as we,l as Ce,b as x,g as Ae,f as Te}from"./index-DQr_hYrl.js";import{A as _e,a as Ee}from"./alert-C_e47U5j.js";import{I as qe}from"./input-BXFQAMFp.js";import{L as Le}from"./label-CoUyTYQ2.js";import{I as J,C as Se,a as Fe}from"./ImageCropDialog-B4zIgawq.js";import{S as _}from"./sparkles-YUVFw8PO.js";import{T as De}from"./trending-up-BHK01Hh7.js";import{H as k}from"./heart-CPIM2Ke7.js";import{F as B}from"./file-text-BLH-e9-V.js";import{U as Pe}from"./user-CZwPb1SC.js";import{B as X}from"./building-2-BFsPi-4G.js";import{C as Re}from"./circle-check-BT2_QnOW.js";import{C as ke}from"./clock-CrtXPeyj.js";import"./Logo-DJHknSUJ.js";import"./ui-vendor-BME24-VV.js";import"./map-pin-B2egFyT_.js";import"./dialog-uVQYQ4ha.js";import"./maximize-BflEInwa.js";function cs(){var G,H;const{user:a,isAuthenticated:E,isStudent:q,refreshUser:Y}=ve(),[,C]=me();p.useEffect(()=>{if(!E){C("/login");return}q||((a==null?void 0:a.role)==="admin"?C("/admin/dashboard"):C("/dashboard/owner"))},[E,q,a==null?void 0:a.role,C]);const{toast:d}=be(),{t}=ye(),[Z,ee]=p.useState("favorites"),{data:c,isLoading:se,error:L}=A({queryKey:["/favorites"],enabled:E&&q,retry:!1,queryFn:async()=>{const s=Ae();if(!s)throw new Error("No authentication token");const r={Authorization:`Bearer ${s}`},oe=`${Te().replace(/\/+$/,"")}/favorites`,u=await fetch(oe,{headers:r});if(!u.ok){const V=await u.json().catch(()=>({error:u.statusText}));throw new Error(V.error||V.message||u.statusText)}const O=await u.json();return Array.isArray(O)?O:[]},staleTime:1e3*60*5,gcTime:1e3*60*15}),{data:U,isLoading:ae}=A({queryKey:["/contracts/my-contracts"],queryFn:async()=>{const s=await x("GET","/contracts/my-contracts");return Array.isArray(s)?s:s!=null&&s.contracts&&Array.isArray(s.contracts)?s.contracts:[]},staleTime:1e3*60*5,gcTime:1e3*60*15}),o=Array.isArray(U)?U:[],{data:I,isLoading:te}=A({queryKey:["/conversations"],queryFn:async()=>{const s=await x("GET","/conversations");return Array.isArray(s)?s:s!=null&&s.conversations&&Array.isArray(s.conversations)?s.conversations:[]},staleTime:1e3*30,gcTime:1e3*60*5}),S=Array.isArray(I)?I:[],re=R({mutationFn:s=>x("DELETE",`/favorites/${s}`),onSuccess:()=>{w.invalidateQueries({queryKey:["/favorites"]})}}),{data:M,isLoading:ie}=A({queryKey:["/requests/sent"],queryFn:async()=>{const s=await x("GET","/requests/sent");return Array.isArray(s)?s:s!=null&&s.requests&&Array.isArray(s.requests)?s.requests:[]},staleTime:1e3*30,gcTime:1e3*60*5}),F=Array.isArray(M)?M:[],K=R({mutationFn:s=>x("DELETE",`/requests/${s}`),onSuccess:()=>{w.invalidateQueries({queryKey:["/requests/sent"]}),d({title:"Success",description:"Request cancelled successfully"})},onError:s=>{d({title:"Error",description:s.message,variant:"destructive"})}}),de=R({mutationFn:s=>x("PUT","/users/profile",s),onSuccess:async()=>{w.invalidateQueries({queryKey:["/auth/profile"]}),w.invalidateQueries({queryKey:["/auth/user"]}),await Y(),d({title:"Success",description:"Profile updated successfully"})},onError:s=>{d({title:"Error",description:s.message,variant:"destructive"})}}),[D,z]=p.useState(!1),[le,$]=p.useState(!1),[Q,P]=p.useState(null),ne=s=>{var h;const r=(h=s.target.files)==null?void 0:h[0];if(!r)return;if(!r.type.startsWith("image/")){d({title:"Erreur",description:"Le fichier doit être une image",variant:"destructive"});return}const m=new FileReader;m.onload=()=>{P(m.result),$(!0)},m.onerror=()=>{d({title:"Erreur",description:"Erreur lors de la lecture du fichier",variant:"destructive"})},m.readAsDataURL(r)},ce=async s=>{z(!0);try{const r=new File([s],"profile-picture.png",{type:"image/png",lastModified:Date.now()}),h=(await Ce(r)).url;await de.mutateAsync({profile_picture:h}),d({title:"Succès",description:"Photo de profil mise à jour"})}catch(r){d({title:"Erreur",description:r instanceof Error?r.message:"Erreur lors de l'upload de la photo",variant:"destructive"})}finally{z(!1),P(null)}};return e.jsx(xe,{children:e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl md:text-4xl font-bold mb-2 flex items-center gap-3","data-testid":"text-dashboard-title",children:[e.jsx(_,{className:"h-7 w-7 text-primary"}),t("dashboard.student.welcome",{name:(a==null?void 0:a.first_name)||""})]}),e.jsxs("p",{className:"text-muted-foreground flex items-center gap-2",children:[e.jsx(De,{className:"h-4 w-4"}),t("dashboard.student.manage")]})]}),e.jsxs("div",{className:"hidden md:flex gap-3",children:[c&&c.length>0&&e.jsx(i,{className:"px-4 py-2 border-primary/20",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"h-4 w-4 text-primary"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Favoris"}),e.jsx("div",{className:"text-lg font-bold",children:c.length})]})]})}),o&&o.length>0&&e.jsx(i,{className:"px-4 py-2 border-primary/20",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-4 w-4 text-primary"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Contrats"}),e.jsx("div",{className:"text-lg font-bold",children:o.length})]})]})})]})]})}),e.jsxs(ge,{value:Z,onValueChange:ee,className:"space-y-6",children:[e.jsxs(Ne,{className:"grid w-full grid-cols-5 lg:w-auto lg:inline-grid",children:[e.jsxs(v,{value:"favorites",className:"gap-2","data-testid":"tab-favorites",children:[e.jsx(k,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.student.favorites")})]}),e.jsxs(v,{value:"requests",className:"gap-2","data-testid":"tab-requests",children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.student.requests")})]}),e.jsxs(v,{value:"messages",className:"gap-2","data-testid":"tab-messages",children:[e.jsx(W,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.student.messages")})]}),e.jsxs(v,{value:"contracts",className:"gap-2","data-testid":"tab-contracts",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.student.contracts")})]}),e.jsxs(v,{value:"profile",className:"gap-2","data-testid":"tab-profile",children:[e.jsx(Pe,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.profile.title")})]})]}),e.jsx(b,{value:"favorites",className:"space-y-4",children:e.jsxs(i,{children:[e.jsxs(j,{children:[e.jsx(g,{children:t("dashboard.student.favorites")}),e.jsx(N,{children:t("dashboard.student.favorites.desc")})]}),e.jsx(l,{children:L?e.jsx(_e,{variant:"destructive",className:"mb-4",children:e.jsx(Ee,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold mb-1",children:"Erreur de chargement"}),e.jsx("p",{className:"text-sm",children:L instanceof Error?L.message:"Erreur inconnue"})]}),e.jsx(n,{variant:"outline",size:"sm",onClick:()=>w.invalidateQueries({queryKey:["/favorites"]}),children:"Réessayer"})]})})}):se?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[1,2,3].map(s=>e.jsx(T,{className:"h-80 w-full"},s))}):!c||c.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted flex items-center justify-center mx-auto mb-4",children:e.jsx(k,{className:"h-10 w-10 text-muted-foreground"})}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:t("dashboard.student.favorites.empty")}),e.jsx("p",{className:"text-muted-foreground mb-6 max-w-md mx-auto",children:t("dashboard.student.favorites.empty.desc")}),e.jsx(f,{href:"/properties",children:e.jsxs(n,{size:"lg",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),t("messages.browse")]})})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:c.map(s=>e.jsx(je,{property:s,isFavorited:!0,onFavoriteToggle:r=>re.mutate(r)},s.id))})})]})}),e.jsx(b,{value:"requests",className:"space-y-4",children:e.jsxs(i,{children:[e.jsxs(j,{children:[e.jsx(g,{children:t("dashboard.student.requests.title")}),e.jsx(N,{children:t("dashboard.student.requests.desc")})]}),e.jsx(l,{children:ie?e.jsx("div",{className:"space-y-4",children:[1,2].map(s=>e.jsx(T,{className:"h-32 w-full"},s))}):!F||F.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted flex items-center justify-center mx-auto mb-4",children:e.jsx(J,{className:"h-10 w-10 text-muted-foreground"})}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:t("dashboard.student.requests.empty")}),e.jsx("p",{className:"text-muted-foreground mb-6 max-w-md mx-auto",children:t("dashboard.student.requests.empty.desc")}),e.jsx(f,{href:"/properties",children:e.jsxs(n,{size:"lg",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Browse Properties"]})})]}):e.jsx("div",{className:"space-y-4",children:F.map(s=>{var r;return e.jsx(i,{className:"hover-elevate transition-all",children:e.jsxs(l,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-lg mb-1",children:s.property_title}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-3 flex items-center gap-2",children:[e.jsx(X,{className:"h-3 w-3"}),s.city_name," • CHF ",(r=s.price)==null?void 0:r.toLocaleString(),"/mois"]}),e.jsx("div",{className:"bg-muted/50 p-3 rounded-md border-l-4 border-primary",children:e.jsxs("p",{className:"text-sm italic",children:['"',s.message,'"']})})]}),e.jsxs(y,{variant:s.status==="accepted"?"default":s.status==="pending"?"secondary":"destructive",className:"gap-1",children:[s.status==="accepted"&&e.jsx(Re,{className:"h-3 w-3"}),s.status==="pending"&&e.jsx(ke,{className:"h-3 w-3"}),s.status]})]}),s.status==="pending"&&e.jsx("div",{className:"flex gap-2 justify-end",children:e.jsxs(n,{variant:"outline",size:"sm",onClick:()=>{confirm("Are you sure you want to cancel this request?")&&K.mutate(s.id)},disabled:K.isPending,children:[e.jsx(we,{className:"h-4 w-4 mr-2"}),"Cancel Request"]})})]})},s.id)})})})]})}),e.jsx(b,{value:"messages",className:"space-y-4",children:e.jsxs(i,{children:[e.jsxs(j,{children:[e.jsx(g,{children:t("messages.conversations")}),e.jsx(N,{children:t("dashboard.student.messages.desc")})]}),e.jsx(l,{children:te?e.jsx("div",{className:"space-y-4",children:[1,2,3].map(s=>e.jsx(T,{className:"h-20 w-full"},s))}):!S||S.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted flex items-center justify-center mx-auto mb-4",children:e.jsx(W,{className:"h-10 w-10 text-muted-foreground"})}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:t("dashboard.student.messages.empty")}),e.jsx("p",{className:"text-muted-foreground mb-6 max-w-md mx-auto",children:t("dashboard.student.messages.empty.desc")}),e.jsx(f,{href:"/properties",children:e.jsxs(n,{size:"lg",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),t("messages.browse")]})})]}):e.jsx("div",{className:"space-y-3",children:S.map(s=>e.jsx(f,{href:`/messages?conversation=${s.id}`,children:e.jsx(i,{className:"hover-elevate cursor-pointer",children:e.jsxs(l,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-md bg-muted flex items-center justify-center flex-shrink-0",children:e.jsx(X,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold truncate",children:s.property_title}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.other_user_name}),s.last_message&&e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.last_message})]}),s.unread_count&&s.unread_count>0&&e.jsx(y,{variant:"default",children:s.unread_count})]})})},s.id))})})]})}),e.jsx(b,{value:"contracts",className:"space-y-4",children:e.jsxs(i,{children:[e.jsxs(j,{children:[e.jsx(g,{children:t("dashboard.student.contracts.title")}),e.jsx(N,{children:t("dashboard.student.contracts.desc")})]}),e.jsx(l,{children:ae?e.jsx("div",{className:"space-y-4",children:[1,2].map(s=>e.jsx(T,{className:"h-32 w-full"},s))}):!o||o.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted flex items-center justify-center mx-auto mb-4",children:e.jsx(B,{className:"h-10 w-10 text-muted-foreground"})}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:t("dashboard.student.contracts.empty")}),e.jsx("p",{className:"text-muted-foreground max-w-md mx-auto",children:t("dashboard.student.contracts.empty.desc")})]}):e.jsx("div",{className:"space-y-4",children:o.map(s=>e.jsx(i,{"data-testid":`card-contract-${s.id}`,children:e.jsxs(l,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-lg",children:s.property_title}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.city_name})]}),e.jsx(y,{variant:s.status==="active"?"default":s.status==="pending"?"secondary":"outline",children:s.status})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Monthly Rent"}),e.jsxs("p",{className:"font-semibold",children:["CHF ",s.monthly_rent.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Duration"}),e.jsxs("p",{className:"font-semibold",children:[new Date(s.start_date).toLocaleDateString()," - ",new Date(s.end_date).toLocaleDateString()]})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(f,{href:`/contracts/${s.id}`,children:e.jsx(n,{variant:"outline",size:"sm",children:"View Details"})})})]})},s.id))})})]})}),e.jsx(b,{value:"profile",className:"space-y-4",children:e.jsxs(i,{children:[e.jsxs(j,{children:[e.jsx(g,{children:t("dashboard.profile.title")}),e.jsx(N,{children:t("dashboard.profile.desc")})]}),e.jsxs(l,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4 pb-4 border-b",children:[e.jsxs(he,{className:"h-24 w-24",children:[e.jsx(ue,{src:a!=null&&a.profile_picture?pe(a.profile_picture):void 0}),e.jsxs(fe,{className:"bg-primary text-primary-foreground text-2xl",children:[(G=a==null?void 0:a.first_name)==null?void 0:G[0],(H=a==null?void 0:a.last_name)==null?void 0:H[0]]})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Le,{htmlFor:"profile-picture-upload-student",className:"cursor-pointer",children:e.jsx(n,{variant:"outline",asChild:!0,disabled:D,children:e.jsxs("span",{children:[e.jsx(Se,{className:"h-4 w-4 mr-2"}),D?"Upload en cours...":"Changer la photo de profil"]})})}),e.jsx(qe,{id:"profile-picture-upload-student",type:"file",accept:"image/*",className:"hidden",onChange:ne,disabled:D}),Q&&e.jsx(Fe,{open:le,onClose:()=>{$(!1),P(null)},imageSrc:Q,onCropComplete:ce,aspectRatio:1,circularCrop:!0}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Formats acceptés: JPG, PNG, WEBP (max 10 MB)"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.first_name")}),e.jsx("p",{className:"font-medium",children:a==null?void 0:a.first_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.last_name")}),e.jsx("p",{className:"font-medium",children:a==null?void 0:a.last_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.email")}),e.jsx("p",{className:"font-medium",children:a==null?void 0:a.email})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.phone")}),e.jsx("p",{className:"font-medium",children:(a==null?void 0:a.phone)||t("dashboard.phone.not_provided")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.account_type")}),e.jsx(y,{children:a==null?void 0:a.role})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("dashboard.profile.email_verified")}),e.jsx(y,{variant:a!=null&&a.email_verified?"default":"secondary",children:a!=null&&a.email_verified?t("dashboard.profile.verified"):t("dashboard.profile.not_verified")})]})]})]})]})})]})]})})}export{cs as default};
